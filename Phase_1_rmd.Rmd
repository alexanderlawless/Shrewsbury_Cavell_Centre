---
title: "Shrewsbury Health and Well-being Hub Analysis - Phase 1"
author: "Alexander Lawless"
date: "26/07/2021"
output:
  html_document:
    theme: cerulean
    toc: TRUE
    toc_float: TRUE
    toc_collapsed: TRUE
    toc_depth: 4
    number_sections: TRUE
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, 
                      message = FALSE,
                      fig.width = 9, 
                      fig.height = 6)

`%!in%` <- Negate(`%in%`)

simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
        sep="", collapse=" ")
}

library(tidyverse)
library(janitor)
library(knitr)
library(DT)
library(patchwork)
library(sf)
library(ggrepel)
library(networkD3)
library(htmlwidgets)
library(readxl)
library(lubridate)
library(scales)
library(png)


inline_hook <- function(x) {
 
  if(is.numeric(x)) {
    formatted <- format(x, digits = 2)
    
  } else {
    formatted <- x
  }
  
   paste0("**", formatted, "**")
  
}

knit_hooks$set(inline = inline_hook)

create_dt <- function(x){
  DT::datatable(x,
                extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                               lengthMenu = list(c(8, 10,50,-1),
                                                 c(8, 10,50,"All"))))
}

## Set SU theme ####
My_rgb2hex <- function(r,g,b) sprintf('#%s',paste(as.hexmode(c(r,g,b)),collapse = ''))

# scale_colour_manual(values = c("#f9bf07", "#686f73", "#5881c1", "#ec6555"))
# scale_colour_manual(values = c("#686f73", "#5881c1", "#ec6555"))

SU_colours <- c (
  `orange` = My_rgb2hex(248,191,7),# "#f9bf07",
  `charcoal` = My_rgb2hex(44,40,37),# "#2c2825",
  `slate` = My_rgb2hex(104,111,115), # "#686f73",
  `blue` = My_rgb2hex(88,29,193), # "#5881c1",
  `red` = My_rgb2hex(236,101,85), # "#ec6555",
  #additional accent colours from word doc template
  `yellow` = My_rgb2hex(252,229,155),
  `grey` = My_rgb2hex(163,168,172),
  `white` = My_rgb2hex(255,255,255),
  #light and dark ends from colour theme in word doc
  `light orange` = My_rgb2hex(253,242,205),
  `dark orange` = My_rgb2hex(124,95,3),
  `light charcoal` = My_rgb2hex(235,233,231),
  `dark charcoal` = 	"#000000",#black
  `light slate` = My_rgb2hex(224,226,227),
  `dark slate` = My_rgb2hex(51,55,57),
  `light blue` = My_rgb2hex(221,229,242),
  `dark blue` = My_rgb2hex(38,61,102),
  `light red` = My_rgb2hex(251,224,220),
  `dark red` = My_rgb2hex(144,29,16),
  `light yellow` = My_rgb2hex(254,249,235),
  `dark yellow` = My_rgb2hex(197,152,5),
  `light grey`=My_rgb2hex(236,237,238),
  `dark grey` = My_rgb2hex(79,84,88),
  `light white`=My_rgb2hex(242,242,242),
  `dark white` =My_rgb2hex(127,127,127),
  `red2` = My_rgb2hex(215,25,28),
  `orange2` = My_rgb2hex(253,174,97),
  `yellow2` = My_rgb2hex(255,255,191),
  `green2` = My_rgb2hex(171,221,164),
  `blue2` = My_rgb2hex(43,131,186)
)



SU_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (SU_colours)
  
  SU_colours[cols]
}

SU_palettes <- list(
  `main` = SU_cols("orange","charcoal","slate","blue","red"),
  `oranges` = SU_cols("light orange","orange","dark orange"),
  `slates` = SU_cols("light slate","slate","dark slate"),
  `mixed` = SU_cols("dark red","orange","yellow","light blue","slate"),
  `oj_coal` = SU_cols("yellow","orange","red","dark red","dark charcoal"),
  `oj_red` = SU_cols("yellow","orange","red","dark red"),
  `white_oj_coal` = SU_cols("white","yellow","orange","red","dark red","dark charcoal"),#added since shared
  `lyellow_oj_coal` = SU_cols("light yellow","orange","red","dark red","dark charcoal"),#added since shared
  `wy_oj_coal` = SU_cols("white","light yellow","yellow","orange","red","dark red","charcoal","dark charcoal"),
  `red_coal` = SU_cols("red","dark red","charcoal","dark charcoal"),
  `blue_yellow_red` = SU_cols("red2","orange2","yellow2","green2","blue2"),
  `red_yellow_blue` = SU_cols("blue2","green2","yellow2","orange2","red2")
)

SU_pal <- function(palette = "main", reverse = FALSE, ...) {
  pal <- SU_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}   

scale_color_SU <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- SU_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("SU_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}


scale_fill_SU <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- SU_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("fill", paste0("SU_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}  

##Theme


##set theme settings
theme_SU<-
  function (base_size){
    theme_minimal(
      #base_family = "Segoe UI", 
      base_size=12
    ) %+replace% 
      theme(axis.title = element_text(size=11, face="bold",colour=SU_cols("charcoal")),
            plot.title = element_text(hjust=0,face="bold",size=12,colour=SU_cols("charcoal"),margin=margin(b=4,unit="pt")),
            plot.subtitle = element_text(hjust=0,face="italic",size=10,colour=SU_cols("charcoal"),margin=margin(b=4,unit="pt")),
            plot.caption = element_text(hjust = 0,face="italic",size=10,colour=SU_cols("slate"),margin=margin(b=4,unit="pt")),
            legend.text = element_text(size=10,colour=SU_cols("charcoal")),
            legend.title = element_text(face="bold",size=11,colour=SU_cols("charcoal"),margin=margin(b=4,unit="pt")))
  }



##set theme by 
theme_set(theme_SU())

## Import data ####

# GP codes 
practices <- c('M82048', 'M82047', 'M82040', 'M82018', 'M82034', 'M82002', 'M82016', 'M82060')

# GP patient demographics 
# https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/june-2021 

a_practice_list_size <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-all.csv") %>% 
  clean_names() %>% 
  filter(code %in% practices) 

a_practice_list_size_male_age <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-sing-age-male.csv") %>% 
  clean_names() %>% 
  filter(org_code %in% practices) %>%
  filter(age != "ALL") %>% 
  mutate(age = as.numeric(age))

a_practice_list_size_female_age <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-sing-age-female.csv") %>% 
  clean_names() %>% 
  filter(org_code %in% practices) %>%
  filter(age != "ALL") %>% 
  mutate(age = as.numeric(age))

simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
        sep="", collapse=" ")
}

a_practice_mapping <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-map.csv") %>% 
  clean_names() %>% 
  filter(practice_code %in% practices) %>% 
  mutate(practice_name = unlist(lapply(practice_name, tolower))) %>%
  mutate(practice_name = unlist(lapply(practice_name, simpleCap)))

# Deprivation by LSOA
a_lsoa_imd_2019 <-
  read_csv("LSOA_IMD_2019.csv") %>% 
  clean_names()

# LSOA distrubution
a_practice_list_size_lsoa <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-lsoa-all.csv") %>% 
  clean_names() %>% 
  filter(practice_code %in% practices) %>% 
  select(-publication) %>% 
  left_join(a_lsoa_imd_2019, by = c("lsoa_code" = "lsoa11cd"))
  
a_practice_list_size_lsoa_male <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-lsoa-male.csv") %>% 
  clean_names() %>% 
  filter(practice_code %in% practices) %>% 
  select(-publication) %>% 
  left_join(a_lsoa_imd_2019, by = c("lsoa_code" = "lsoa11cd"))

a_practice_list_size_lsoa_female <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-lsoa-female.csv") %>% 
  clean_names() %>% 
  filter(practice_code %in% practices) %>% 
  select(-publication) %>% 
  left_join(a_lsoa_imd_2019, by = c("lsoa_code" = "lsoa11cd"))

# Monthly practice list sizes (mass import)
#2018
prac_pop_jan18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jan-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_feb18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-feb-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_mar18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-mar-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_apr18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-apr-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_may18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-may-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_jun18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jun-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_jul18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jul-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_aug18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-aug-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_sep18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-sep-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_oct18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-oct-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_nov18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-nov-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_dec18 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-dec-18.csv") %>% 
  clean_names() %>% filter(code %in% practices)

#2019
prac_pop_jan19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jan-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_feb19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-feb-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_mar19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-mar-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_apr19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-apr-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_may19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-may-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_jun19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jun-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_jul19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jul-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_aug19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-aug-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_sep19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-sep-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_oct19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-oct-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_nov19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-nov-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_dec19 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-dec-19.csv") %>% 
  clean_names() %>% filter(code %in% practices)

#2020
prac_pop_jan20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jan-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_feb20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-feb-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_mar20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-mar-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_apr20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-apr-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_may20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-may-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_jun20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jun-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_jul20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jul-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_aug20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-aug-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_sep20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-sep-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_oct20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-oct-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_nov20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-nov-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_dec20 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-dec-20.csv") %>% 
  clean_names() %>% filter(code %in% practices)

#2021
prac_pop_jan21 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-jan-21.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_feb21 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-feb-21.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_mar21 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-mar-21.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_apr21 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-apr-21.csv") %>% 
  clean_names() %>% filter(code %in% practices)
prac_pop_may21 <- read_csv("Practice_list_demographics/Practice_population/gp-reg-pat-prac-all-may-21.csv") %>% 
  clean_names() %>% filter(code %in% practices)

prac_pop_monthly <- 
prac_pop_jan18 %>% 
union(prac_pop_feb18)%>% 
union(prac_pop_mar18)%>% 
union(prac_pop_apr18)%>% 
union(prac_pop_may18)%>% 
union(prac_pop_jun18)%>% 
union(prac_pop_jul18)%>% 
union(prac_pop_aug18)%>% 
union(prac_pop_sep18)%>% 
union(prac_pop_oct18)%>% 
union(prac_pop_nov18)%>% 
union(prac_pop_dec18)%>% 
union(prac_pop_jan19)%>% 
union(prac_pop_feb19)%>% 
union(prac_pop_mar19)%>% 
union(prac_pop_apr19)%>% 
union(prac_pop_may19)%>% 
union(prac_pop_jun19)%>% 
union(prac_pop_jul19)%>% 
union(prac_pop_aug19)%>% 
union(prac_pop_sep19)%>% 
union(prac_pop_oct19)%>% 
union(prac_pop_nov19)%>% 
union(prac_pop_dec19)%>% 
union(prac_pop_jan20)%>% 
union(prac_pop_feb20)%>% 
union(prac_pop_mar20)%>% 
union(prac_pop_apr20)%>% 
union(prac_pop_may20)%>% 
union(prac_pop_jun20)%>% 
union(prac_pop_jul20)%>% 
union(prac_pop_aug20)%>% 
union(prac_pop_sep20)%>% 
union(prac_pop_oct20)%>% 
union(prac_pop_nov20)%>% 
union(prac_pop_dec20)%>% 
union(prac_pop_jan21)%>% 
union(prac_pop_feb21)%>% 
union(prac_pop_mar21)%>% 
union(prac_pop_apr21)%>% 
union(prac_pop_may21) %>% 
  mutate(extract_date = as.Date(extract_date, format = "%d%b%Y"))

rm(
  prac_pop_jan18,
  prac_pop_feb18,
  prac_pop_mar18,
  prac_pop_apr18,
  prac_pop_may18,
  prac_pop_jun18,
  prac_pop_jul18,
  prac_pop_aug18,
  prac_pop_sep18,
  prac_pop_oct18,
  prac_pop_nov18,
  prac_pop_dec18,
  prac_pop_jan19,
  prac_pop_feb19,
  prac_pop_mar19,
  prac_pop_apr19,
  prac_pop_may19,
  prac_pop_jun19,
  prac_pop_jul19,
  prac_pop_aug19,
  prac_pop_sep19,
  prac_pop_oct19,
  prac_pop_nov19,
  prac_pop_dec19,
  prac_pop_jan20,
  prac_pop_feb20,
  prac_pop_mar20,
  prac_pop_apr20,
  prac_pop_may20,
  prac_pop_jun20,
  prac_pop_jul20,
  prac_pop_aug20,
  prac_pop_sep20,
  prac_pop_oct20,
  prac_pop_nov20,
  prac_pop_dec20,
  prac_pop_jan21,
  prac_pop_feb21,
  prac_pop_mar21,
  prac_pop_apr21,
  prac_pop_may21
)

# PHE GP profiles 
# https://fingertips.phe.org.uk/profile/general-practice/data#page/9/gid/3000010/pat/166/par/E38000147/ati/7/are/M82048/iid/219/age/1/sex/4/cid/4/tbm/1

phe_fing_gp_amr              <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_amr.csv") %>% clean_names()
phe_fing_gp_cancer           <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_cancer.csv")%>% clean_names()
phe_fing_gp_cancer_referral  <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_cancer_referrals.csv")%>% clean_names()
phe_fing_gp_cvd_chd          <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_cvd_chd.csv")%>% clean_names()
phe_fing_gp_cvd_hf_af        <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_cvd_hf_af.csv")%>% clean_names()
phe_fing_gp_cvd_stroke       <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_cvd_stroke.csv")%>% clean_names()
phe_fing_gp_diabetes         <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_diabetes.csv")%>% clean_names()
phe_fing_gp_mh               <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_mh.csv")%>% clean_names()
phe_fing_gp_msk              <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_msk.csv")%>% clean_names()
phe_fing_gp_other            <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_other.csv")%>% clean_names()
phe_fing_gp_practice_summary <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_practice_summary.csv")%>% clean_names()
phe_fing_gp_resp             <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_resp.csv")%>% clean_names()
phe_fing_gp_cvd_risk         <- read_csv("Practice_list_demographics/Fingertips_GP/GP.data_cvd_risk.csv")%>% clean_names()

# Reduce PHE GP data
reduce_GP_data <- function(data){
    data %>% 
    select(
      indicator_id, indicator_name, area_code, area_name, sex, age, time_period, 
      count, denominator, value, lower_ci_95_0_limit, upper_ci_95_0_limit
      )
} 

phe_fing_gp_amr %>% 
select(
  indicator_id, indicator_name, area_code, area_name, sex, age, time_period, 
  count, denominator, value, lower_ci_95_0_limit, upper_ci_95_0_limit
)

phe_fing_gp_amr              <- reduce_GP_data(phe_fing_gp_amr)
phe_fing_gp_cancer           <- reduce_GP_data(phe_fing_gp_cancer)
phe_fing_gp_cancer_referral  <- reduce_GP_data(phe_fing_gp_cancer_referral)
phe_fing_gp_cvd_chd          <- reduce_GP_data(phe_fing_gp_cvd_chd)
phe_fing_gp_cvd_hf_af        <- reduce_GP_data(phe_fing_gp_cvd_hf_af)
phe_fing_gp_cvd_risk         <- reduce_GP_data(phe_fing_gp_cvd_risk)
phe_fing_gp_cvd_stroke       <- reduce_GP_data(phe_fing_gp_cvd_stroke)
phe_fing_gp_diabetes         <- reduce_GP_data(phe_fing_gp_diabetes)
phe_fing_gp_mh               <- reduce_GP_data(phe_fing_gp_mh)
phe_fing_gp_msk              <- reduce_GP_data(phe_fing_gp_msk)
phe_fing_gp_other            <- reduce_GP_data(phe_fing_gp_other)
phe_fing_gp_practice_summary <- reduce_GP_data(phe_fing_gp_practice_summary)
phe_fing_gp_resp             <- reduce_GP_data(phe_fing_gp_resp)

phe_clinical_indicators <-
  phe_fing_gp_amr  %>%
  union(phe_fing_gp_cancer) %>%          
  union(phe_fing_gp_cancer_referral ) %>%
  union(phe_fing_gp_cvd_chd         ) %>%
  union(phe_fing_gp_cvd_hf_af       ) %>%
  union(phe_fing_gp_cvd_risk        ) %>%
  union(phe_fing_gp_cvd_stroke      ) %>%
  union(phe_fing_gp_diabetes        ) %>%
  union(phe_fing_gp_mh              ) %>%
  union(phe_fing_gp_msk             ) %>%
  union(phe_fing_gp_other           ) %>%
  union(phe_fing_gp_resp            ) %>% 
  filter(area_code %in% practices)

## Describe population demographics ####
# Patient population pyramids
# Count
b_practice_pop_pyramid <-
a_practice_list_size_male_age %>% 
  left_join(a_practice_mapping %>% 
              select(practice_code, practice_name), by = c("org_code" = "practice_code")) %>% 
  select(org_code, practice_name, age, number_of_patients) %>% 
  rename(male_patient_count = number_of_patients) %>% 
  left_join(
    a_practice_list_size_female_age %>% 
      select(org_code, age, number_of_patients) %>% 
      rename(female_patient_count = number_of_patients),
    by = c("org_code", "age")
  ) %>% 
  mutate(male_patient_count_neg = -male_patient_count) 


## Deprivation ####
practice_pop_imd_decile <- 
a_practice_list_size_lsoa %>% 
  select(lsoa_code, practice_code, number_of_patients, imd_decil) %>% 
  left_join(a_practice_mapping %>% 
              select(practice_code, practice_name), by = c("practice_code")) %>% 
  group_by(practice_name, imd_decil) %>% 
  summarise(count = sum(number_of_patients)) %>% 
  mutate(prop = count/sum(count)*100) 
## Clinical profile ####
phe_clinical_indicators_qof_comb <-
phe_clinical_indicators %>% 
  filter(str_detect(indicator_name, "QOF")) %>% 
  group_by(indicator_id, indicator_name, time_period) %>% 
  summarise(comb_count = sum(count),
            comb_denom = sum(denominator)) %>% 
  mutate(comb_value = comb_count/comb_denom*100) %>% 
  ungroup()

qof_indicator_desc <-
tribble(
  ~indicator_id, ~desc, ~group,
  212,  "Stroke", "CVD",
  219,  "Hypertension", "CVD",
  241,  "Diabetes", "General",
  247,  "Dementia", "General",
  253,  "COPD", "Resp", 
  258,  "CKD", "General",
  262,  "HF", "CVD",
  273,  "CHD", "CVD",
  276,  "Cancer", "General",
  280,  "AF", "CVD",
  285,  "Athsma", "Resp",
  90581, "Mental Health", "MH",
  90646, "Depression", "MH",
  91269, "RA", "General",
  91280, "Smoking", "Resp",
  92588, "Obesity", "General",)

## Consultation data ####

cons_jan19 <- read_csv("Consultation_data/CCG_CSV_Jan_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_feb19 <- read_csv("Consultation_data/CCG_CSV_Feb_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_mar19 <- read_csv("Consultation_data/CCG_CSV_Mar_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_apr19 <- read_csv("Consultation_data/CCG_CSV_Apr_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_may19 <- read_csv("Consultation_data/CCG_CSV_May_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_jun19 <- read_csv("Consultation_data/CCG_CSV_Jun_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_jul19 <- read_csv("Consultation_data/CCG_CSV_Jul_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_aug19 <- read_csv("Consultation_data/CCG_CSV_Aug_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_sep19 <- read_csv("Consultation_data/CCG_CSV_Sep_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_oct19 <- read_csv("Consultation_data/CCG_CSV_Oct_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_nov19 <- read_csv("Consultation_data/CCG_CSV_Nov_19.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_dec19 <- read_csv("Consultation_data/CCG_CSV_Dec_19.csv") %>% filter(STP_ONS_CODE == "E54000011")

cons_jan20 <- read_csv("Consultation_data/CCG_CSV_Jan_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_feb20 <- read_csv("Consultation_data/CCG_CSV_Feb_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_mar20 <- read_csv("Consultation_data/CCG_CSV_Mar_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_apr20 <- read_csv("Consultation_data/CCG_CSV_Apr_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_may20 <- read_csv("Consultation_data/CCG_CSV_May_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_jun20 <- read_csv("Consultation_data/CCG_CSV_Jun_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_jul20 <- read_csv("Consultation_data/CCG_CSV_Jul_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_aug20 <- read_csv("Consultation_data/CCG_CSV_Aug_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_sep20 <- read_csv("Consultation_data/CCG_CSV_Sep_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_oct20 <- read_csv("Consultation_data/CCG_CSV_Oct_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_nov20 <- read_csv("Consultation_data/CCG_CSV_Nov_20.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_dec20 <- read_csv("Consultation_data/CCG_CSV_Dec_20.csv") %>% filter(STP_ONS_CODE == "E54000011")

cons_jan21 <- read_csv("Consultation_data/CCG_CSV_Jan_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_feb21 <- read_csv("Consultation_data/CCG_CSV_Feb_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_mar21 <- read_csv("Consultation_data/CCG_CSV_Mar_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_apr21 <- read_csv("Consultation_data/CCG_CSV_Apr_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
cons_may21 <- read_csv("Consultation_data/CCG_CSV_May_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
#cons_jun21 <- read_csv("Consultation_data/CCG_CSV_Jun_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
#cons_jul21 <- read_csv("Consultation_data/CCG_CSV_Jul_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
#cons_aug21 <- read_csv("Consultation_data/CCG_CSV_Aug_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
#cons_sep21 <- read_csv("Consultation_data/CCG_CSV_Sep_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
#cons_oct21 <- read_csv("Consultation_data/CCG_CSV_Oct_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
#cons_nov21 <- read_csv("Consultation_data/CCG_CSV_Nov_21.csv") %>% filter(STP_ONS_CODE == "E54000011")
#cons_dec21 <- read_csv("Consultation_data/CCG_CSV_Dec_21.csv") %>% filter(STP_ONS_CODE == "E54000011")

consultations <-
  cons_jan19 %>% 
  union(cons_feb19) %>% 
  union(cons_mar19) %>%
  union(cons_apr19) %>%
  union(cons_may19) %>%
  union(cons_jun19) %>%
  union(cons_jul19) %>%
  union(cons_aug19) %>%
  union(cons_sep19) %>%
  union(cons_oct19) %>%
  union(cons_nov19) %>%
  union(cons_dec19) %>%
  union(cons_jan20) %>%
  union(cons_feb20) %>%
  union(cons_mar20) %>%
  union(cons_apr20) %>%
  union(cons_may20) %>%
  union(cons_jun20) %>%
  union(cons_jul20) %>%
  union(cons_aug20) %>%
  union(cons_sep20) %>%
  union(cons_oct20) %>%
  union(cons_nov20) %>%
  union(cons_dec20) %>%
  union(cons_jan21) %>%
  union(cons_feb21) %>%
  union(cons_mar21) %>%
  union(cons_apr21) %>%
  union(cons_may21) %>% 
  clean_names() 

rm(
  cons_jan19,
  cons_feb19,
  cons_mar19,
  cons_apr19,
  cons_may19,
  cons_jun19,
  cons_jul19,
  cons_aug19,
  cons_sep19,
  cons_oct19,
  cons_nov19,
  cons_dec19,
  cons_jan20,
  cons_feb20,
  cons_mar20,
  cons_apr20,
  cons_may20,
  cons_jun20,
  cons_jul20,
  cons_aug20,
  cons_sep20,
  cons_oct20,
  cons_nov20,
  cons_dec20,
  cons_jan21,
  cons_feb21,
  cons_mar21,
  cons_apr21,
  cons_may21
  ) 

# Compare age/sex profile of 8x practices to other practices in CCG
# ons_ccg_code == E38000257 

STW_practices <-
  read_csv("Practice_list_demographics/gp-reg-pat-prac-sing-age-male.csv") %>% 
  clean_names() %>% 
  filter(ons_ccg_code == "E38000257") %>% 
  select(org_code) %>% 
  distinct() # 8x practices out of 52 total

STW_practices_external_flag <-
STW_practices %>% 
  mutate(external = case_when(org_code %in% practices ~ "internal", 
                              TRUE ~ "external")) %>% 
  inner_join(read_csv("Practice_list_demographics/gp-reg-pat-prac-sing-age-male.csv") %>% 
               clean_names() %>% 
               select(org_code, sex, age, number_of_patients),
             by = c("org_code")
             ) %>%
  left_join(read_csv("Practice_list_demographics/gp-reg-pat-prac-sing-age-female.csv") %>% 
               clean_names() %>% 
               select(org_code, sex, age, number_of_patients),
             by = c("org_code", "age")
  ) %>% 
  rename(male_count = number_of_patients.x,
         female_count = number_of_patients.y) %>% 
  select(-sex.x, -sex.y) %>%
  mutate(age = as.numeric(age)) 

# Check shape of Age/Gender distribution of Cavel centres against other CCG patients
STW_practices_external_flag_long <-
STW_practices_external_flag %>%
  group_by(external, age) %>% 
  summarise(male_sum = sum(male_count),
            female_sum = sum(female_count)) %>% 
  mutate(male_prop = male_sum/sum(male_sum)*100,
         female_prop = female_sum/sum(female_sum) *100) %>%
  mutate(male_prop_neg = -male_prop) %>% 
  select(external, age, female_prop, male_prop_neg) %>% 
  pivot_longer(cols = c(-external, -age)) %>% 
  mutate(name = case_when(name == "female_prop" ~ "Female",
                          name == "male_prop_neg" ~ "Male")) %>% 
  mutate(external = case_when(external == "external" ~ "Other Practices in CCG",
                              external == "internal" ~ "8x Cavell Practices")) 

consultations_cavell <-
consultations %>% 
  select(ccg_ons_code, appointment_date, appt_status, 
         hcp_type, appt_mode, time_between_book_and_appt, 
         count_of_appointments) %>% 
  mutate(appointment_date = as.Date(appointment_date, format = "%d%b%Y")) %>% 
  mutate(cavell_appts = count_of_appointments*0.128)



## OPA care ####
opa_by_speciality <- 
  read_csv("Activity_data_raw/OPA_by_Speciality_19_20.csv") %>% 
  clean_names() %>% 
  rename(practice_name = x2)

opa_colated <- 
  read_csv("Activity_data_raw/OPA_colocated_1620.csv") %>% 
  clean_names() %>% 
  mutate(appointment_date = as.Date(appointment_date, "%d/%m/%Y"))

opa_colated <- 
  read_csv("Activity_data_raw/OPA_colocated_1620.csv") %>% 
  clean_names() %>% 
  mutate(appointment_date = as.Date(appointment_date, "%d/%m/%Y"))

opa_colated_19 <-
  opa_colated %>% 
  filter(substr(appointment_date,1,4) == "2019")


# Grouping of outpatient appointment in line with previous work (FutureFit)
#1 Attendances - High volume speciality  (follow-up)
#2 Attendances - High volume speciality (first attendance - single professional - no scanning)
#3 Telephone appointment - Low volume speciality
#4 Outpatient procedure - adult diagnostic appointment with no scanning
#5 Outpatient procedure - Adult operation/scan in High volume speciality

procedure_mri <- c("U133", #U133: Magnetic resonance imaging of bone
                   "U211", #U211: Magnetic resonance imaging NEC
                   "U012"  #U012: Magnetic resonance imaging of whole body) 
)
procedure_ct <- c("U212", #U212: Computed tomography NEC
                  "U011", #U011: Computed tomography of whole body
                  "U214"  #U214: Single photon emission computed tomography NEC
)
proceudre_uss <- c("U132", #U132: Ultrasound of bone
                   "U216"  #U216: Ultrasound scan NEC
)
procedure_xray <- c("Y981", #Y981: Radiology of one body area (or < 20 minutes)
                    "U131", #U131: Bone densitometry
                    "U183"  #U183: Mammography)
)
procedure_contrast <- c("Y973") #Y973: Radiology with post contrast

opa_colated <- 
  read_csv("Activity_data_raw/OPA_colocated_1620.csv") %>% 
  clean_names() %>% 
  mutate(appointment_date = as.Date(appointment_date, "%d/%m/%Y")) %>% 
  mutate(child_adult = 
           case_when(
             age_at_start_of_episode_sus < 18 ~ "Child",
             TRUE ~ "Adult"
           )) %>% 
  mutate(high_volume_speciality = 
           case_when(
             main_specialty_code %in% c(
               110, #	Trauma and Orthopaedics
               300, # General internal medicine
               130, # Opthamology
               100, # General surgery
               314 #  Rehabilitation medicine
             ) ~ "Yes", 
             TRUE ~ "No")) %>% 
  mutate(attendance_type = 
           case_when(
             str_detect(sus_hrg, "WF01") ~ "Attendance - Single professional",
             str_detect(hrg_code, "WF01") ~ "Attendance - Single professional",
             str_detect(sus_hrg, "WF02") ~ "Attendance - Multi professional",
             str_detect(hrg_code, "WF02") ~ "Attendance - Multi professional",
             TRUE ~ "Procedure"
           )) %>% 
  mutate(first_or_fu = 
           case_when(
             first_attendance %in% c(
               1,	#First attendance face to face
               3	#First telephone or Telemedicine consultation
             ) ~ "First atttendance",
             first_attendance %in% c(
               2,	#Follow-up attendance face to face
               4,	#Follow-up telephone or Telemedicine consultation
               5	#Referral To Treatment Clock Stop Administrative Event
             ) ~ "Follow-up"
           )) %>% 
  mutate(imaging = 
           case_when(
             str_detect(der_procedure_all, paste(procedure_mri, collapse = "|")) ~ "MRI",
             str_detect(der_procedure_all, paste(procedure_ct, collapse = "|")) ~ "CT",
             str_detect(der_procedure_all, paste(proceudre_uss, collapse = "|")) ~ "USS",
             str_detect(der_procedure_all, paste(procedure_xray, collapse = "|")) ~ "Xray",
             str_detect(der_procedure_all, paste(procedure_contrast, collapse = "|")) ~ "Contrast",
             TRUE ~ "No imaging"))

opa_colated_19 <-
  opa_colated %>% 
  filter(substr(appointment_date,1,4) == "2019")


# Grouped OPA data for clinical confirmation
opa_colated_19_grouped <-         
  opa_colated_19 %>% 
  group_by(
    #child_adult, 
    #high_volume_speciality, 
    first_or_fu, 
    attendance_type, 
    imaging
    ) %>% 
  summarise(n = n_distinct(opa_ident)) %>% 
  drop_na(first_or_fu) %>% 
  ungroup() %>% 
  arrange(first_or_fu, attendance_type, desc(n)) %>% 
  ungroup()

# OPA Sankey diagram
library(highcharter)
opa_sankey <-
  hchart(
    data_to_sankey(
      opa_colated_19 %>%
        select(first_or_fu, attendance_type, imaging)
      ), "sankey", 
       name = "Outpatient demand by appointment groups")

## Community care - ShropCom referrals ####
# Source of referral look up
com_ref_souce_desc_lookup <-
  tribble(
    ~code, ~ref_souce_desc,
    "01",	"General Medical Practitioner Practice",
    "02",	"Self referral",
    "03",	"Carer/Relative",
    "04",	"Employer",
    "05",	"Emergency Care Department",
    "06",	"Acute Hospital Inpatient/Outpatient Department",
    "07",	"Community Health Service",
    "08",	"Dental Practice",
    "09",	"National Screening Programme",
    "10",	"Educational Establishment",
    "11",	"Local Authority Social Services",
    "12",	"Hospice",
    "13",	"Care Home",
    "14",	"Police",
    "15",	"Courts",
    "16",	"Probation Service",
    "17",	"Prison Health Service",
    "18",	"Asylum Service",
    "19",	"Telephone or Electronic Access Service",
    "20",	"Voluntary Sector",
    "21",	"Independent Sector",
    "22",	"Ambulance Service",
    "23",	"Mental Health Service",
  )

ShropCom_refs_1620 <- 
  read_csv("Activity_data_raw/ShropCom_refs_1620.csv")

names(ShropCom_refs_1620) <- 
  c('RECORDNUMBER',
    'PatientID',
    'GENDERCODE', 
    'ETHNICCATEGORY',
    'PROVIDERCODE',
    'PROVIDERORGCODE',
    'CCGOFRESIDENCE',
    'LSOA2011',
    'AGEATREPORTINGPERIODSTART_DER',
    'SERVICEREQID',
    'REFERRALREQRECDATE',
    'SOURCEOFREFERRALFORCOMMUNITY',
    'REFERRINGORGCODE',
    'PRIMARYREASONFORREFERRAL',
    'PRACTICECODE',
    'CCGOFGPPRACTICE',
    'ReasonForReferralToCommunityCareID',
    'ReasonForReferralToCommunityCareCode',
    'ReasonForReferralToCommunityCareDescription',
    'ReasonForReferralToCommunityCareDescriptionShort',
    'ReasonForReferralToCommunityCareIsLatest',
    'ReasonForReferralToCommunityCareAuditKeyID')

ShropCom_refs_1620 <-
  ShropCom_refs_1620 %>% 
  clean_names() %>% 
  mutate(child_adult = 
           case_when(
             ageatreportingperiodstart_der <= 18 ~ "Child",
             TRUE ~ "Adult")) %>% 
  left_join(com_ref_souce_desc_lookup, by = c("sourceofreferralforcommunity" = "code")) %>% 
  mutate(source_ref_type = 
           case_when(
             sourceofreferralforcommunity %in% c(01) ~ "GP",
             sourceofreferralforcommunity %in% c(05, 06, 22) ~ "Acute",
             TRUE ~ "Other")) %>% 
  mutate(high_volume_reason = 
           case_when(
             reason_for_referral_to_community_care_description_short %in% c(
               "Foot care/problems", 
               "Healthy child pathway",
               "Musculoskeletal problems",
               "Haematology/phlebotomy",
               "Diabetes") ~ "High-volume reason",
             TRUE ~ "Low-volume reason"))

ShropCom_refs_1620 %>% 
  filter(substr(referralreqrecdate,1,4) == "2019") %>% 
  group_by(reason_for_referral_to_community_care_description_short) %>% 
  summarise(referrals = n(),
            individuals = n_distinct(patient_id),
            ref_per_person = round(n()/n_distinct(patient_id),1),
            ratio = round(n_distinct(patient_id)/n(),3)) %>% 
  arrange(desc(referrals)) %>% 
  rename(reason_for_referral = reason_for_referral_to_community_care_description_short) %>% 
  filter(reason_for_referral != 'NULL') %>% 
  head(10)

# # A tibble: 10 x 5
# reason_for_referral           referrals individuals ref_per_person ratio
# <chr>                             <int>       <int>          <dbl> <dbl>
# 1 Foot care/problems               106808         925          116.  0.009
# 2 Reason for referral not known     80345         806           99.7 0.01 
# 3 Healthy child pathway             22084        1164           19   0.053
# 4 Musculoskeletal problems          21077           7         3011   0    
# 5 Haematology/phlebotomy            17781          44          404.  0.002
# 6 Diabetes                          16351          61          268   0.004
# 7 Speech and language problems      13755         114          121.  0.008
# 8 Continence problems               11764          89          132.  0.008
# 9 Wound care                        11076          21          527.  0.002

# Forcing ShropCom data into "From-to" structure
ShropCom_flow <-
# Stage 1 - Age
  ShropCom_refs_1620 %>% 
  group_by(child_adult) %>% 
  summarise(n = n()) %>% 
  mutate(ID = "A",
         from = "A) Referrals") %>% 
  rename(to = child_adult) %>% 
  mutate(to = paste("B)", to)) %>% 
  select(ID, from, to, n) %>% 
  union(
    # Stage 2 - Source of referrals
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Adult") %>% 
      group_by(source_ref_type) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "B",
             from = "B) Adult") %>% 
      rename(to = source_ref_type) %>%
      mutate(to = paste("C)", to)) %>% 
      select(ID, from, to, n)) %>% 
  union(
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Child") %>% 
      group_by(source_ref_type) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "C",
             from = "B) Child") %>% 
      rename(to = source_ref_type) %>% 
      mutate(to = paste("D)", to)) %>% 
      select(ID, from, to, n)) %>% 
  # Stage 3 - Reason for referral (high or low volume)
  union(
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Adult",
             source_ref_type == "GP") %>% 
      group_by(high_volume_reason) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "D",
             from = "C) GP") %>% 
      rename(to = high_volume_reason) %>%
      mutate(to = paste("E)", to)) %>% 
      select(ID, from, to, n)) %>% 
  union(
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Adult",
             source_ref_type == "Acute") %>% 
      group_by(high_volume_reason) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "E",
             from = "C) Acute") %>% 
      rename(to = high_volume_reason) %>% 
      mutate(to = paste("F)", to)) %>% 
      select(ID, from, to, n)) %>% 
  union( 
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Adult",
             source_ref_type == "Other") %>% 
      group_by(high_volume_reason) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "F",
             from = "C) Other") %>% 
      rename(to = high_volume_reason) %>% 
      mutate(to = paste("G)", to)) %>%
      select(ID, from, to, n)) %>% 
  union(
    # Child 
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Child",
             source_ref_type == "GP") %>% 
      group_by(high_volume_reason) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "G",
             from = "D) GP") %>% 
      rename(to = high_volume_reason) %>% 
      mutate(to = paste("H)", to)) %>%
      select(ID, from, to, n)) %>% 
  union(
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Child",
             source_ref_type == "Acute") %>% 
      group_by(high_volume_reason) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "H",
             from = "D) Acute") %>% 
      rename(to = high_volume_reason) %>% 
      mutate(to = paste("I)", to)) %>%
      select(ID, from, to, n)) %>% 
  union(
    ShropCom_refs_1620 %>% 
      filter(child_adult == "Child",
             source_ref_type == "Other") %>% 
      group_by(high_volume_reason) %>% 
      summarise(n = n()) %>% 
      mutate(ID = "I",
             from = "D) Other") %>% 
      rename(to = high_volume_reason) %>% 
      mutate(to = paste("J)", to)) %>%
      select(ID, from, to, n)) %>% 
  select(-ID) %>% 
  rename(weight = n) %>% 
  mutate(weight = as.numeric(weight))

# Nodes
ShropCom_nodes <-
  data.frame(
    ShropCom_flow %>% 
      select(from) %>% 
      rename(nodes = from) %>%
      union(
        ShropCom_flow %>% 
          select(to) %>% 
          rename(nodes = to)) %>% 
      distinct() %>% 
      rowid_to_column() %>% 
      mutate(rowid = as.numeric(rowid-1)) %>% 
      
      left_join(ShropCom_flow %>% 
                  mutate(to_value = paste0(to, ": ", weight)) %>% 
                  select(to, to_value),
                by = c("nodes" = "to")) %>% #Bring in merged node names (name + value) from 'to' column
      mutate(to_value = case_when(is.na(to_value)~ paste0(nodes, ": 874301"),
                                  TRUE ~ to_value))  #All contacts will be NA - manually replace total
    )

# Links/edges
ShropCom_links <-
  data.frame(
    ShropCom_flow %>% 
      left_join(ShropCom_nodes, by = c("from" = "nodes")) %>% 
      rename(source = rowid) %>% 
      mutate(source = as.numeric(source)) %>% 
      left_join(ShropCom_nodes, by = c("to" = "nodes")) %>% 
      rename(target = rowid) %>% 
      mutate(target = as.numeric(target)) %>% 
      select(source, target, weight)
    )

ShropCom_flow_vis <-
  sankeyNetwork(Links = ShropCom_links, 
                Nodes = ShropCom_nodes,
                Source = "source",
                Target = "target",
                Value = "weight",
                NodeID = "to_value",
                fontFamily = "sans-serif",
                unit = "Referrals", 
                fontSize = 15)

## Community care - ShropCom care contacts ####
# Consultation medium 
# https://www.datadictionary.nhs.uk/archive/DD%20Release%20December%202019/data_dictionary/attributes/c/cons/consultation_medium_used_de.asp?shownav=1
consultation_medium_type <-
  tribble(
    ~code, ~cons_medium_desc,
    "01",	"Face to face communication",
    "02",	"Telephone",
    "03",	"Telemedicine",
    "04",	"Talk type for a PERSON unable to speak",
    "05",	"Email",
    "06",	"Short Message Service (SMS) - Text Messaging",
    "07",	"On-line Triage",
    "98",	"Other (not listed)")

# Community care activity
# https://datadictionary.nhs.uk/data_elements/community_care_activity_type.html 
care_activity_type <-
  tribble(
    ~code, ~activity_type_desc,
    "01", "Administering Tests",
    "02", "Assessment",
    "03", "CLINICAL INTERVENTION", 
    "04", "Counselling, Advice, Support",
    "05", "PATIENT  Specific Health Promotion",
    "06", "Multidisciplinary Team Review",
    "07", "Supporting Another Clinician",
    "08", "Health Visitor  New Birth Visit",
    "09", "Health Visitor  Health Review (6-8 weeks)",
    "10", "Health Visitor Health Review (1 year)",
    "11", "Health Visitor  Health Review (2-2.5 years)",
    "12", "Health Visitor Formal handover to School Nursing Service (4-5 years)",
    "97", "Other (not listed)",
    "98", "Other (Retired 01 September 2015)"
  )

ActivityLocationTypeCode_lookup <- 
  read_csv("ActivityLocationTypeCode_lookup.csv") %>% 
  select(-1, -3)

ShropCom_contacts_1620 <- 
  read_csv("Activity_data_raw/ShropCom_contacts_1620_location.csv")

names(ShropCom_contacts_1620) <- 
    c(
      'RECORDNUMBER',
      'PatientID',
      'GENDERCODE',
      'ETHNICCATEGORY',
      'PROVIDERCODE',
      'PROVIDERORGCODE',
      'CCGOFRESIDENCE',
      'LSOA2011',
      'AGEATREPORTINGPERIODSTART_DER',
      'SERVICEREQID',
      'ACTLOCATIONTYPE',
      'CARECONTACTID',
      'CARECONTACTDATE',
      'ADMINCATCODE',
      'CONSULTATIONTYPE',
      'CARECONTACTSUBJECT',
      'CONMEDIUMUSED',
      'SITECODE',
      'PRACTICECODE',
      'CCGOFGPPRACTICE',
      'CSURowNumber',
      'CAREACTIVITYID',
      'CARECONTACTID',
      'ACTIVITYTYPECODE',
      'CAREPROFLOCALID',
      'CONTACTDURATION',
      'PROCSCHEME',
      'PROCEDURECODE',
      'SCHEMEINUSE',
      'FINDINGCODE',
      'OBSSCHEMEINUSE',
      'OBSCODE',
      'OBSVALUE',
      'UCUMUNIT',
      'RECORDNUMBER',
      'CYP202UNIQUEID',
      'PROVIDERORGCODE',
      'UNIQUECSDSID',
      'BSPUNIQUEID',
      'UNIQUEARECONTACTID',
      'UNIQUECAREACTID',
      'DatasetId',
      'FileId',
      'TransactionId',
      'SubmittedZipFile',
      'SubmittedFile',
      'ProviderCodeUserEmail',
      'ReceivedDate',
      'LoadDate',
      'REPORTINGPERIODSTARTDATE',
      'REPORTINGPERIODENDDATE',
      'FILETYPE',
      'CurrentRecord',
      'FileName',
      'EFFECTIVE_FROM',
      'DatSetVer',
      'Unique_MonthID'
      )

ShropCom_contacts_1620 <-
  ShropCom_contacts_1620 %>% 
  clean_names() %>% 
  mutate(carecontactdate = as.Date(carecontactdate)) %>% 
  select(recordnumber, 
         patient_id,
         ageatreportingperiodstart_der, 
         carecontactid, 
         servicereqid,
         admincatcode,
         carecontactdate,
         consultationtype, 
         conmediumused, 
         careactivityid, 
         activitytypecode,
         carecontactid, 
         carecontactdate,
         actlocationtype
         ) %>% 
  # Age
  mutate(child_adult = 
           case_when(
             ageatreportingperiodstart_der <= 18 ~ "Child",
             TRUE ~ "Adult")) %>% 
  # Consultation medium 
  left_join(consultation_medium_type, by = c("conmediumused" = "code")) %>% 
  mutate(consult_type_group = 
           case_when(
             conmediumused == "01" ~ "Face-to-face",
             TRUE ~ "Other")) %>% 
  # Activity type
  left_join(care_activity_type, by = c("activitytypecode" = "code")) %>% 
  mutate(contact_activity_group = 
           case_when(
             activity_type_desc %in% c("Administering Tests", "Assessment") ~ "Assessment/Tests",
             activity_type_desc %in% c("CLINICAL INTERVENTION") ~ "Clinical Intervention",
             str_detect(activity_type_desc, "Health Visitor") ~ "Health visitor",
             is.na(activity_type_desc) ~ "Unknown", 
             TRUE ~ "Other"))  %>% 
  # Activity location
  left_join(ActivityLocationTypeCode_lookup, by = c("actlocationtype" = "ActivityLocationTypeCodeCode"))

ShropCom_contacts <-
  ShropCom_contacts_1620 %>%
  filter(substr(carecontactdate,1,4) == "2019") # Adjust year filter as necessary for Sankey diagram
  
ShropCom_contacts %>% 
  summarise(
    row_count = n(),
    record_count = n_distinct(recordnumber),
    care_contact_count = n_distinct(carecontactid))

# Grouped contacts by consultation mode, activity and location - For excel output and clinical selection
ShropCom_contacts_1620  %>% 
  group_by(consult_type_group,
           contact_activity_group,
           ActivityLocationTypeGroup) %>% 
  summarise(care_contacts = n_distinct(carecontactid)) %>% 
  ungroup() %>% 
  group_by(consult_type_group,
           contact_activity_group,
           ActivityLocationTypeGroup) %>% 
  arrange(desc(care_contacts))

## ShropCom Contacts Sankey ####
# Flow/sankey data
ShropCom_contacts_flow <-
  # Age
  ShropCom_contacts %>% 
  mutate(from = "A) All care contacts") %>% 
  group_by(from, child_adult) %>% 
  summarise(care_contacts = n_distinct(carecontactid)) %>% 
  mutate(child_adult = paste("B)", child_adult)) %>% 
  rename(to = child_adult) %>% 
  # Contact medium
  union(
    ShropCom_contacts %>% 
      filter(child_adult == "Adult") %>% 
      mutate(from = "B) Adult") %>% 
      group_by(from, consult_type_group) %>% 
      summarise(care_contacts = n_distinct(carecontactid)) %>% 
      mutate(consult_type_group = paste("C)", consult_type_group)) %>% 
      rename(to = consult_type_group)) %>% 
  union(
    ShropCom_contacts %>% 
      filter(child_adult == "Child") %>% 
      mutate(from = "B) Child") %>% 
      group_by(from, consult_type_group) %>% 
      summarise(care_contacts = n_distinct(carecontactid)) %>% 
      mutate(consult_type_group = paste("D)", consult_type_group)) %>% 
      rename(to = consult_type_group)) %>% 
  # Contact activity type
  union(
    ShropCom_contacts %>% 
      filter(child_adult == "Adult",
             consult_type_group == "Face-to-face") %>% 
      mutate(from = "C) Face-to-face") %>% 
      group_by(from, contact_activity_group) %>% 
      summarise(care_contacts = n_distinct(carecontactid)) %>% 
      mutate(contact_activity_group = paste("E)", contact_activity_group)) %>% 
      rename(to = contact_activity_group)) %>% 
  union(
    ShropCom_contacts %>% 
      filter(child_adult == "Adult",
             consult_type_group == "Other") %>% 
      mutate(from = "C) Other") %>% 
      group_by(from, contact_activity_group) %>% 
      summarise(care_contacts = n_distinct(carecontactid)) %>% 
      mutate(contact_activity_group = paste("F)", contact_activity_group)) %>% 
      rename(to = contact_activity_group)) %>% 
  union(
    ShropCom_contacts %>% 
      filter(child_adult == "Child",
             consult_type_group == "Face-to-face") %>% 
      mutate(from = "D) Face-to-face") %>% 
      group_by(from, contact_activity_group) %>% 
      summarise(care_contacts = n_distinct(carecontactid)) %>% 
      mutate(contact_activity_group = paste("G)", contact_activity_group)) %>% 
      rename(to = contact_activity_group)) %>% 
  union(
    ShropCom_contacts %>% 
      filter(child_adult == "Child",
             consult_type_group == "Other") %>% 
      mutate(from = "D) Other") %>% 
      group_by(from, contact_activity_group) %>% 
      summarise(care_contacts = n_distinct(carecontactid)) %>% 
      mutate(contact_activity_group = paste("H)", contact_activity_group)) %>% 
      rename(to = contact_activity_group)) %>% 
  ungroup()

# Nodes
ShropCom_contacts_nodes <-
  data.frame(
    ShropCom_contacts_flow %>% 
      select(from) %>% 
      rename(nodes = from) %>%
      union(
        ShropCom_contacts_flow %>% 
          select(to) %>% 
          rename(nodes = to)
      ) %>% 
      distinct() %>% 
      rowid_to_column() %>% 
      mutate(rowid = as.numeric(rowid-1)) %>% 
      left_join(ShropCom_contacts_flow %>% 
                  mutate(to_value = paste0(to, ": ", care_contacts)) %>% 
                  select(to, to_value),
                by = c("nodes" = "to")) %>% #Bring in merged node names (name + value) from 'to' column
      mutate(to_value = case_when(is.na(to_value)~ paste0(nodes, ": 82496"),   ## Remember to manually add in the overall total (fudge!)
                                  TRUE ~ to_value))  
    )

# Links/edges
ShropCom_contact_links <-
  data.frame(
    ShropCom_contacts_flow %>% 
      left_join(ShropCom_contacts_nodes, by = c("from" = "nodes")) %>% 
      rename(source = rowid) %>% 
      mutate(source = as.numeric(source)) %>% 
      left_join(ShropCom_contacts_nodes, by = c("to" = "nodes")) %>% 
      rename(target = rowid) %>% 
      mutate(target = as.numeric(target)) %>% 
      select(source, target, care_contacts)
  )

ShropCom_contact_vis <-
sankeyNetwork(Links = ShropCom_contact_links, 
              Nodes = ShropCom_contacts_nodes,
              Source = "source",
              Target = "target",
              Value = "care_contacts",
              NodeID = "to_value", #Merged field with node name and contact count
              nodeWidth = 15,
              unit = "care contacts", 
              fontSize = 12,
              fontFamily = "sans-serif"
              )

## Community care - ShropCom care contacts & referrals ####
# Add either location of contact or clinician type 
ShropCom_refs_1620_reduced <-
  ShropCom_refs_1620 %>% 
  select(recordnumber, 
         patient_id, 
         servicereqid, 
         referralreqrecdate, 
         sourceofreferralforcommunity,
         primaryreasonforreferral,
         reason_for_referral_to_community_care_code,
         reason_for_referral_to_community_care_description_short,
         )

# Combine contacts and referrals ()
ShropCom_contacts_refs <-
ShropCom_contacts_1620  %>%
  left_join(ShropCom_refs_1620_reduced, 
            by = c("servicereqid", "recordnumber", "patient_id"), 
            keep = FALSE)

# Group contact-referrals data by fields of interest
ShropCom_contacts_refs_2019_grouped <-
ShropCom_contacts_refs %>% 
  filter(substr(carecontactdate,1,4) == "2019") %>% 
  group_by(#child_adult,
           consult_type_group,
           contact_activity_group,
           reason_for_referral_to_community_care_description_short,
           ActivityLocationTypeGroup) %>% 
  summarise(care_contacts = n_distinct(carecontactid))

# Pivot wider by contact location
ShropCom_contacts_location <-
ShropCom_contacts_refs_2019_grouped %>% 
  group_by(consult_type_group,
           contact_activity_group,
           ActivityLocationTypeGroup) %>% 
  summarise(care_contacts = sum(care_contacts)) %>% 
  pivot_wider(id_cols = c(1,2),
              names_from = ActivityLocationTypeGroup,
              values_from = care_contacts) %>% 
  clean_names()

#write_csv(ShropCom_contacts_location, "ShropCom_contacts_location.csv")

# Arrange grouped data - descending contact counts
ShropCom_contacts_refs_2019_grp_arranged <-
  ShropCom_contacts_refs_2019_grouped %>%
  rename(reason_for_ref = reason_for_referral_to_community_care_description_short) %>% 
  filter(reason_for_ref %!in% c(
    "NULL", "Reason for referral not known")) %>% 
  drop_na(reason_for_ref) %>% 
  mutate(prop = care_contacts/sum(care_contacts)*100) %>% 
  mutate(reason_for_ref = 
           case_when(
             prop < 1 ~ "Other",
             TRUE ~ reason_for_ref
             )) %>% 
  group_by(#child_adult,
           consult_type_group,
           contact_activity_group,
           ActivityLocationTypeGroup,
           reason_for_ref
           ) %>% 
  summarise(care_contacts = sum(care_contacts)) %>% 
  mutate(prop = round(care_contacts/sum(care_contacts)*100,2)) %>% 
  arrange(#child_adult, 
          consult_type_group, 
          contact_activity_group, 
          ActivityLocationTypeGroup,
          desc(care_contacts)
          ) 
  

#write_csv(ShropCom_contacts_refs_2019_grp_arranged, "ShropCom_contacts_refs_2019_grp_arranged.csv")

## Mental health ####

# MHSDS data - contact activity   

# MHSDS - Activity Location Type Code
# https://datadictionary.nhs.uk/attributes/activity_location_type_code.html
mhsds_activity_location_type_code_lookup <-
  tribble(
  ~code,	~description,
  "A01",	"Patients Home",
  "A02",	"Carer's Home",
  "A03",	"Patient's Workplace",
  "A04",  "Other Patient Related Location",
  "B01",	"Primary Care Health Centre",
  "B02",	"Polyclinic",
  "C01",	"General Medical Practitioner Practice",
  "C02",	"Dental Practice",
  "C03",	"Ophthalmic Medical Practitioner Premises",
  "D01",	"Walk In Centre",
  "D02",	"Out of Hours Centre",
  "D03",	"Emergency Community Dental Service",
  "E01",	"Out-Patient Clinic",
  "E02",	"Ward",
  "E03",	"Day Hospital",
  "E04",	"Emergency Care Department or Minor Injuries Department",
  "E99",	"Other Departments",
  "F01",	"Hospice",
  "G01",	"Care Home Without Nursing",
  "G02",	"Care Home With Nursing",
  "G03",	"Children's Home",
  "G04",  "Integrated Care Home Without Nursing  and Care Home With Nursing",
  "H01",	"Day Centre",
  "J01",	"Resource Centre",
  "K01",	"Sure Start Children’s Centre",
  "K02",	"Child Development Centre",
  "L01",	"School",
  "L02",	"Further Education College",
  "L03",	"University",
  "L04",	"Nursery Premises",
  "L05",	"Other Childcare Premises",
  "L06",	"Training Establishments",
  "L99",	"Other Educational Premises",
  "M01",	"Prison",
  "M02",	"Probation Service Premises",
  "M03",	"Police Station / Police Custody Suite",
  "M04",	"Young Offender Institution",
  "M05",	"Immigration Removal Centre",
  "M06",	"Young Offender Institution (15-17)",
  "M07",	"Young Offender Institution (18-21)",
  "N01",	"Street or other public open space",
  "N02",	"Other publicly accessible area or building",
  "N03",	"Voluntary or charitable agency premises",
  "N04",	"Dispensing Optician Premises",
  "N05",	"Dispensing Pharmacy Premises",
  "X01",	"Other locations not elsewhere classified"
  )

# Consultation medium 
# https://www.datadictionary.nhs.uk/archive/DD%20Release%20December%202019/data_dictionary/attributes/c/cons/consultation_medium_used_de.asp?shownav=1
consultation_medium_type <-
  tribble(
    ~code, ~cons_medium_desc,
    "01",	"Face to face communication",
    "02",	"Telephone",
    "03",	"Telemedicine",
    "04",	"Talk type for a PERSON unable to speak",
    "05",	"Email",
    "06",	"Short Message Service (SMS) - Text Messaging",
    "07",	"On-line Triage",
    "98",	"Other (not listed)")

# Service or team type referred to
# https://datadictionary.nhs.uk/attributes/service_or_team_type_for_mental_health.html

service_team_type_referred_to <-
  tribble(
    ~code, ~team_service_desc,
    
    "A01", "Day Care Service",
    "A02", "Crisis Resolution Team/Home Treatment Service",
    "A03", "Crisis Resolution Team",
    "A04", "Home Treatment Service",
    "A05", "Primary Care Mental Health Service",
    "A06", "Community Mental Health Team - Functional",
    "A07", "Community Mental Health Team - Organic",
    "A08", "Assertive Outreach Team",
    "A09", "Community Rehabilitation Service",
    "A10", "General Psychiatry Service",
    "A11", "Psychiatric Liaison Service",
    "A12", "Psychotherapy Service",
    "A13", "Psychological Therapy Service (non IAPT)",
    "A14", "Early Intervention Team for Psychosis",
    "A15", "Young Onset Dementia Team",
    "A16", "Personality Disorder Service",
    "A17", "Memory Services/Clinic",
    "A18", "Single Point of Access Service",
    "A19", "24/7 Crisis Response Line",
    "A20", "Health Based Place of Safety Service",
    "A21", "Crisis Café/Safe Haven/Sanctuary Service",
    "A22", "Walk-in Crisis Assessment Unit Service",
    "A23", "Psychiatric Decision Unit Service",
    "A24", "Acute Day Service",
    "A25", "Crisis House Service",
    "B01", "Forensic Mental Health Service",
    "B02", "Forensic Learning Disability Service",
    "C01", "Autistic Spectrum Disorder Service",
    "C02", "Specialist Perinatal Mental Health Community Service",
    "C03", "Eating Disorders/Dietetics Service (Retired 1 April 2020)",
    "C04", "Neurodevelopment Team",
    "C05", "Paediatric Liaison Service",
    "C06", "Looked After Children Service",
    "C07", "Youth Offending Service",
    "C08", "Acquired Brain Injury Service",
    "C09", "Community Eating Disorder Service (CEDS) for Children and Young People (Retired 1 April 2020)",
    "C10", "Community Eating Disorder Service",
    "D01", "Substance Misuse Team",
    "D02", "Criminal Justice Liaison and Diversion Service",
    "D03", "Prison Psychiatric Inreach Service",
    "D04", "Asylum Service",
    "D05", "Individual Placement and Support Service",
    "D06", "Mental Health In Education Service",
    "D07", "Problem Gambling Service",
    "D08", "Rough Sleeping Service",
    "E01", "Community Team for Learning Disabilities",
    "E02", "Epilepsy/Neurological Service",
    "E03", "Specialist Parenting Service",
    "E04", "Enhanced/Intensive Support Service",
    "Z01", "Other Mental Health Service - in scope of National Tariff Payment System",
    "Z02", "Other Mental Health Service - out of scope of National Tariff Payment System"
    )

# Import MHSDS contact, referral and team data in one
mhsds_contacts_1620 <-
  read_csv("Activity_data_raw/MH_Cavell_pts_contacts_refs_team_1620.csv") %>% 
  clean_names() %>% 
  left_join(mhsds_activity_location_type_code_lookup, by = c("act_loc_type_code" = "code")) %>% 
  #select(act_loc_type_code, description) %>% 
  drop_na(description) %>% 
  mutate(location_type_group = 
           case_when(
             act_loc_type_code %in% c("B01", "B02", "C01") ~ "Primary Care",
             act_loc_type_code %in% c("E02", "E03", "E04", "E99", "F01") ~ "Inpatient",
             act_loc_type_code %in% c("D01", "D02", "E01") ~ "Outpatient",
             TRUE ~ "Community")) %>% 
  mutate(child_adult = 
           case_when(
             age_rep_period_start < 18 ~ "Child",
             TRUE ~ "Adult"
           )) %>% 
  mutate(cons_medium_used = as.numeric(cons_medium_used)) %>% 
  left_join(consultation_medium_type %>% 
              mutate(code = as.numeric(code)),
            by = c("cons_medium_used" = "code")) %>% 
  mutate(cons_medium = 
           case_when(
             cons_medium_used == 01 ~ "Face-to-face",
             TRUE ~ "Other"
           )) %>% 
  mutate(care_cont_date = as.Date(care_cont_date, "%d/%m/%Y")) %>% 
  left_join(service_team_type_referred_to, by = c("serv_team_type_ref_to_mh" = "code"))


mhsds_contacts_19 <-
mhsds_contacts_1620  %>% 
  filter(substr(care_cont_date, 1,4) == "2019")

mhsds_contacts_19_grouped <-
  mhsds_contacts_19 %>% 
  group_by(child_adult, cons_medium, location_type_group, team_service_desc) %>% 
  summarise(contact_count = n_distinct(care_contact_id))

#write_csv(mhsds_contacts_19_grouped, "mhsds_contacts_19_grouped.csv")

# Reorganised
# Flow/sankey data
mhsds__contacts_flow <-
  # Age
  mhsds_contacts_19 %>% 
  mutate(from = "A) All care contacts") %>% 
  group_by(from, child_adult) %>% 
  summarise(care_contacts = n_distinct(care_contact_id)) %>% 
  mutate(child_adult = paste("B)", child_adult)) %>% 
  rename(to = child_adult) %>% 
  # Contact medium
  union(
    mhsds_contacts_19 %>% 
      filter(child_adult == "Adult") %>% 
      mutate(from = "B) Adult") %>% 
      group_by(from, cons_medium) %>% 
      summarise(care_contacts = n_distinct(care_contact_id)) %>% 
      mutate(cons_medium = paste("C)", cons_medium)) %>% 
      rename(to = cons_medium)) %>% 
  union(
    mhsds_contacts_19 %>% 
      filter(child_adult == "Child") %>% 
      mutate(from = "B) Child") %>% 
      group_by(from, cons_medium) %>% 
      summarise(care_contacts = n_distinct(care_contact_id)) %>% 
      mutate(cons_medium = paste("D)", cons_medium)) %>% 
      rename(to = cons_medium)) %>% 
  # Contact activity type
  union(
    mhsds_contacts_19 %>% 
      filter(child_adult == "Adult",
             cons_medium == "Face-to-face") %>% 
      mutate(from = "C) Face-to-face") %>% 
      group_by(from, location_type_group) %>% 
      summarise(care_contacts = n_distinct(care_contact_id)) %>% 
      mutate(location_type_group = paste("E)", location_type_group)) %>% 
      rename(to = location_type_group)) %>% 
  union(
    mhsds_contacts_19 %>% 
      filter(child_adult == "Adult",
             cons_medium == "Other") %>% 
      mutate(from = "C) Other") %>% 
      group_by(from, location_type_group) %>% 
      summarise(care_contacts = n_distinct(care_contact_id)) %>% 
      mutate(location_type_group = paste("F)", location_type_group)) %>% 
      rename(to = location_type_group)) %>% 
  union(
    mhsds_contacts_19 %>% 
      filter(child_adult == "Child",
             cons_medium == "Face-to-face") %>% 
      mutate(from = "D) Face-to-face") %>% 
      group_by(from, location_type_group) %>% 
      summarise(care_contacts = n_distinct(care_contact_id)) %>% 
      mutate(location_type_group = paste("G)", location_type_group)) %>% 
      rename(to = location_type_group)) %>% 
  union(
    mhsds_contacts_19 %>% 
      filter(child_adult == "Child",
             cons_medium == "Other") %>% 
      mutate(from = "D) Other") %>% 
      group_by(from, location_type_group) %>% 
      summarise(care_contacts = n_distinct(care_contact_id)) %>% 
      mutate(location_type_group = paste("H)", location_type_group)) %>% 
      rename(to = location_type_group)) %>% 
  ungroup()

# Nodes
mhsds_contacts_nodes <-
  data.frame(
    mhsds__contacts_flow %>% 
      select(from) %>% 
      rename(nodes = from) %>%
      union(
        mhsds__contacts_flow %>% 
          select(to) %>% 
          rename(nodes = to)
      ) %>% 
      distinct() %>% 
      rowid_to_column() %>% 
      mutate(rowid = as.numeric(rowid-1)) %>% 
      left_join(mhsds__contacts_flow %>% 
                  mutate(to_value = paste0(to, ": ", care_contacts)) %>% 
                  select(to, to_value),
                by = c("nodes" = "to")) %>% #Bring in merged node names (name + value) from 'to' column
      mutate(to_value = case_when(is.na(to_value)~ paste0(nodes, ": 29828"),
                                  TRUE ~ to_value))  #All contacts will be NA - manually replace total
  )

# Links/edges
mhsds_contact_links <-
  data.frame(
    mhsds__contacts_flow %>% 
      left_join(mhsds_contacts_nodes, by = c("from" = "nodes")) %>% 
      rename(source = rowid) %>% 
      mutate(source = as.numeric(source)) %>% 
      left_join(mhsds_contacts_nodes, by = c("to" = "nodes")) %>% 
      rename(target = rowid) %>% 
      mutate(target = as.numeric(target)) %>% 
      select(source, target, care_contacts)
  )

mhsds_contact_vis <-
  sankeyNetwork(Links = mhsds_contact_links, 
                Nodes = mhsds_contacts_nodes,
                Source = "source",
                Target = "target",
                Value = "care_contacts",
                NodeID = "to_value", #Merged field with node name and contact count
                nodeWidth = 15,
                unit = "care contacts", 
                fontSize = 12,
                fontFamily = "sans-serif", 
                #colourScale = mycolourscale
  )

# 'Community' includes mental health contacts in the following settings:
# Dental
# Care Home
# Education
# Nursey facility
# Prison setting
# Immigration facilities

## IAPT ####

# https://datadictionary.nhs.uk/data_elements/appointment_type__improving_access_to_psychological_therapies_.html
iapt_app_type <-
  tribble(
    ~apptype,	~apptype_desc,
    "01", "Assessment",
    "02", "Treatment",
    "03", "Assessment and Treatment",
    "04", "Review Only",
    "05", "Review and Treatment",
    "06", "Follow-up appointment after treatment end",
    "07", "Other (not listed)"
  )

iapt_therapy_type <-
  tribble(
    ~TherapyTypeId, ~TherapyTypeCode,	~TherapyTypeDescription,
    1	, "20",	"Guided self help (book)",
    2	, "21",	"Non-guided self help (book)",
    3	, "22",	"Guided self help (computer)",
    4	, "23",	"Non-guided self help (computer)",
    5	, "24",	"Behavioural activation (low intensity)",
    6	, "25",	"Structured physical activity",
    7	, "26",	"Ante/post natal counselling",
    8	, "27",	"Psychoeducational peer support",
    9	, "28",	"Other low intensity",
    10, "29",	"Employment support (low intensity)",
    11, "40",	"Applied relaxation",
    12, "41",	"Behavioural activation (high intensity)",
    13, "42",	"Couples therapy for depression",
    14, "43",	"Collaborative care (for people with depression and a chronic physical health condition)",	
    15, "44",	"Counselling for depression",
    16, "45",	"Brief psychodynamic psychotherapy",
    17, "46",	"Eye movement desensitisation reprocessing",
    18, "47",	"Mindfulness",
    19, "48",	"Other high intensity (not specified above)",
    20, "49",	"Employment support (high intensity)",
    21, "50",	"Cognitive behaviour therapy (CBT)",
    22, "51",	"Interpersonal psycho therapy (IPT)"
  )

iapt <- 
  read_csv("Activity_data_raw/IAPT_appts_1620.csv") %>% 
  clean_names() %>% 
  mutate(child_adult = 
           case_when(
             age_start_reporting_period < 18 ~ "Child",
             TRUE ~ "Adult"
           )) %>% 
  left_join(iapt_app_type, by = c("apptype")) %>% 
  mutate(cons_medium_group = 
           case_when(consmedium == "01" ~ "Face-to-face",
                     TRUE ~ "Other")) %>% 
  left_join(iapt_therapy_type, by = c("thertype1" = "TherapyTypeCode"))

iapt %>% 
  summarise(
    iapt_person_id_count = n_distinct(iapt_person_id),
    pseudo_number_count = n_distinct(pseudo_number),
    iapt_record_number_count = n_distinct(iapt_record_number),
    appt_count = n_distinct(appointment_id)
    )

# Monthly IAPT 
iapt_monthly_count <-
iapt %>% 
  select(appointment, appointment_id) %>% 
  group_by(substr(appointment,1,7)) %>%
  summarise(appt_count = n_distinct(appointment_id)) %>% 
  rename(date = 1) %>% 
  mutate(date = as.Date(paste0(date,"-01"))) 

iapt_monthly_count %>% 
  ggplot(aes(x = date, y = appt_count)) +
  geom_smooth(method = 'loess', span = 0.2, colour = "#f9bf07") +
  labs(x = "Date", y = "Appointment count", 
       title = "Monthly IAPT appointments for Shrewsbury Health and Well-being Hub GP patients, 2016-20.")

# Describe IAPT contacts by therapy type 
iapt %>%
  group_by(child_adult, cons_medium_group, TherapyTypeDescription) %>% 
  summarise(n = n_distinct(appointment_id)) %>% 
  drop_na(TherapyTypeDescription) 

# Annual IAPT contacts
iapt %>% 
  mutate(year = year(appointment)) %>% 
  group_by(year, TherapyTypeDescription) %>% 
  summarise(appointments = n_distinct(appointment_id)) %>% 
  mutate(year = as.character(year)) %>% 
  pivot_wider(id_cols = TherapyTypeDescription, names_from = year, values_from = appointments) %>% 
  drop_na(TherapyTypeDescription) %>% 
  clean_names() %>% 
  filter(x2020 > 1)

# Visualise annual IAPT appointments by type 
iapt %>% 
  mutate(year = year(appointment)) %>% 
  group_by(year, TherapyTypeDescription) %>% 
  summarise(appointments = n_distinct(appointment_id)) %>% 
  mutate(year = as.character(year)) %>% 
  drop_na(TherapyTypeDescription) %>%
  filter(appointments > 50) %>% 
  
  ggplot(aes(x = appointments, y = reorder(TherapyTypeDescription, appointments), 
             fill = TherapyTypeDescription)) +
  geom_col() +
  facet_wrap(~year) +
  scale_fill_SU() +
  theme(legend.position = "none", 
        strip.text = element_text(face = "bold")) +
  scale_x_continuous(labels = scales::comma) +
  labs(title = "Annual counts of IAPT appointments for Shrewsbury Health and Well-being Hub patients by therapy type, 2016-20",
       subtitle = "...",
       x = "Appointments", y = "Therapy type")
## Diagnostic data ####

# DM01 monthly returns
# https://www.england.nhs.uk/statistics/statistical-work-areas/diagnostics-waiting-times-and-activity/monthly-diagnostics-waiting-times-and-activity/monthly-diagnostics-data-2021-22/

provider_codes <- c("R1D", # ShropCom
                    "RL1", # The Robert Jones and Agnes Hunt Orthopaedic Hospital NHS 
                    "RXW"  # The Shrewsbury and Telford Hospital NHS Trust
                    )
# Group 1
# 2016
dm01_apr_16 <- read_csv("DM01/April - 2016.csv", skip = 4)     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_may_16 <- read_csv("DM01/May - 2016.csv", skip = 4)       %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_jun_16 <- read_csv("DM01/June - 2016.csv", skip = 4)      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_jul_16 <- read_csv("DM01/July - 2016.csv", skip = 4)      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_aug_16 <- read_csv("DM01/August - 2016.csv", skip = 4)    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_sep_16 <- read_csv("DM01/September - 2016.csv", skip = 4) %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_oct_16 <- read_csv("DM01/October - 2016.csv", skip = 4)   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_nov_16 <- read_csv("DM01/November - 2016.csv", skip = 4)  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_dec_16 <- read_csv("DM01/December - 2016.csv", skip = 4)  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
# 2017
dm01_jan_17 <- read_csv("DM01/January - 2017.csv", skip = 4)   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_feb_17 <- read_csv("DM01/February - 2017.csv", skip = 4)  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_mar_17 <- read_csv("DM01/March - 2017.csv", skip = 4 )    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_apr_17 <- read_csv("DM01/April - 2017.csv", skip = 4)     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_may_17 <- read_csv("DM01/May - 2017.csv", skip = 4)       %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_jun_17 <- read_csv("DM01/June - 2017.csv", skip = 4)      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_jul_17 <- read_csv("DM01/July - 2017.csv", skip = 4)      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_aug_17 <- read_csv("DM01/August - 2017.csv", skip = 4)    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_sep_17 <- read_csv("DM01/September - 2017.csv", skip = 4) %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_oct_17 <- read_csv("DM01/October - 2017.csv", skip = 4)   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_nov_17 <- read_csv("DM01/November - 2017.csv", skip = 4)  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_dec_17 <- read_csv("DM01/December - 2017.csv", skip = 4)  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
# 2018
dm01_jan_18 <- read_csv("DM01/January - 2018.csv", skip = 4)   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)
dm01_feb_18 <- read_csv("DM01/February - 2018.csv", skip = 4)  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1:12, 70)

# Change from Year-Month to Period
# Group 2
dm01_mar_18 <- read_csv("DM01/March - 2018.csv")     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_apr_18 <- read_csv("DM01/April - 2018.csv")     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_may_18 <- read_csv("DM01/May - 2018.csv")       %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_jun_18 <- read_csv("DM01/June - 2018.csv")      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_jul_18 <- read_csv("DM01/July - 2018.csv")      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_aug_18 <- read_csv("DM01/August - 2018.csv")    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_sep_18 <- read_csv("DM01/September - 2018.csv") %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_oct_18 <- read_csv("DM01/October - 2018.csv")   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_nov_18 <- read_csv("DM01/November - 2018.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_dec_18 <- read_csv("DM01/December - 2018.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
# 2019
dm01_jan_19 <- read_csv("DM01/January - 2019.csv")   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_feb_19 <- read_csv("DM01/February - 2019.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_mar_19 <- read_csv("DM01/March - 2019.csv")     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_apr_19 <- read_csv("DM01/April - 2019.csv")     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_may_19 <- read_csv("DM01/May - 2019.csv")       %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_jun_19 <- read_csv("DM01/June - 2019.csv")      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_jul_19 <- read_csv("DM01/July - 2019.csv")      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_aug_19 <- read_csv("DM01/August - 2019.csv")    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_sep_19 <- read_csv("DM01/September - 2019.csv") %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_oct_19 <- read_csv("DM01/October - 2019.csv")   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_nov_19 <- read_csv("DM01/November - 2019.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_dec_19 <- read_csv("DM01/December - 2019.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
# 2020
dm01_jan_20 <- read_csv("DM01/January - 2020.csv")   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_feb_20 <- read_csv("DM01/February - 2020.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_mar_20 <- read_csv("DM01/March - 2020.csv")     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_apr_20 <- read_csv("DM01/April - 2020.csv")     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_may_20 <- read_csv("DM01/May - 2020.csv")       %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_jun_20 <- read_csv("DM01/June - 2020.csv")      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_jul_20 <- read_csv("DM01/July - 2020.csv")      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_aug_20 <- read_csv("DM01/August - 2020.csv")    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_sep_20 <- read_csv("DM01/September - 2020.csv") %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_oct_20 <- read_csv("DM01/October - 2020.csv")   %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_nov_20 <- read_csv("DM01/November - 2020.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_dec_20 <- read_csv("DM01/December - 2020.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
# 2021
dm01_jan_21 <- read_csv("DM01/January - 2021.csv")  %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_feb_21 <- read_csv("DM01/February - 2021.csv") %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_mar_21 <- read_csv("DM01/March - 2021.csv")    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_apr_21 <- read_csv("DM01/April - 2021.csv")    %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_may_21 <- read_csv("DM01/May - 2021.csv")      %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)
dm01_jun_21 <- read_csv("DM01/June - 2021.csv")     %>% clean_names() %>% filter(provider_org_code %in% provider_codes) %>% select(1, 4:11, 30)

# Union (group 1)
dm01_group_1 <-
  dm01_apr_16 %>% 
    union(dm01_may_16) %>% 
    union(dm01_jun_16) %>% 
    union(dm01_jul_16) %>% 
    union(dm01_aug_16) %>% 
    union(dm01_sep_16) %>% 
    union(dm01_oct_16) %>% 
    union(dm01_nov_16) %>% 
    union(dm01_dec_16) %>% 
    union(dm01_jan_17) %>% 
    union(dm01_feb_17) %>% 
    union(dm01_mar_17) %>% 
    union(dm01_apr_17) %>% 
    union(dm01_may_17) %>% 
    union(dm01_jun_17) %>% 
    union(dm01_jul_17) %>% 
    union(dm01_aug_17) %>% 
    union(dm01_sep_17) %>% 
    union(dm01_oct_17) %>% 
    union(dm01_nov_17) %>% 
    union(dm01_dec_17) %>% 
    union(dm01_jan_18) %>% 
    union(dm01_feb_18) %>% 
  mutate(period = 
           case_when(
             period_name %in% c(
               "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER") 
             ~ paste0(period_name,"-",substr(year,1,4)),
             TRUE 
             ~ paste0(period_name,"-", substr(year,1,2), substr(year,6,7)))) %>% 
  #select(year, period_name, period)
  select(-year, -period_name) %>% 
  select(period, 3:12) %>% 
  rename(total_activity = total_activity_sum)
          
# Union (group 2)
dm01_group_2 <-
  dm01_mar_18 %>% 
    union(dm01_apr_18) %>% 
    union(dm01_may_18) %>% 
    union(dm01_jun_18) %>% 
    union(dm01_jul_18) %>% 
    union(dm01_aug_18) %>% 
    union(dm01_sep_18) %>% 
    union(dm01_oct_18) %>% 
    union(dm01_nov_18) %>% 
    union(dm01_dec_18) %>% 
    union(dm01_jan_19) %>% 
    union(dm01_feb_19) %>% 
    union(dm01_mar_19) %>% 
    union(dm01_apr_19) %>% 
    union(dm01_may_19) %>% 
    union(dm01_jun_19) %>% 
    union(dm01_jul_19) %>% 
    union(dm01_aug_19) %>% 
    union(dm01_sep_19) %>% 
    union(dm01_oct_19) %>% 
    union(dm01_nov_19) %>% 
    union(dm01_dec_19) %>% 
    union(dm01_jan_20) %>% 
    union(dm01_feb_20) %>% 
    union(dm01_mar_20) %>% 
    union(dm01_apr_20) %>% 
    union(dm01_may_20) %>% 
    union(dm01_jun_20) %>% 
    union(dm01_jul_20) %>% 
    union(dm01_aug_20) %>% 
    union(dm01_sep_20) %>% 
    union(dm01_oct_20) %>% 
    union(dm01_nov_20) %>% 
    union(dm01_dec_20) %>% 
    union(dm01_jan_21) %>% 
    union(dm01_feb_21) %>% 
    union(dm01_mar_21) %>% 
    union(dm01_apr_21) %>% 
    union(dm01_may_21) %>% 
    union(dm01_jun_21) %>% 
  mutate(period = substring(period, 6))

# Union both groups with converted period/date fields
dmo01_union <-
  dm01_group_1 %>% 
  union(dm01_group_2) %>%
  mutate(period = tolower(period)) %>% 
  mutate(date = as.Date(parse_date_time(period, orders = c("bdy", "bY")))) %>% 
  select(date, 1:10)  

# Clean environment
rm(
  dm01_apr_16,
  dm01_may_16,
  dm01_jun_16,
  dm01_jul_16,
  dm01_aug_16,
  dm01_sep_16,
  dm01_oct_16,
  dm01_nov_16,
  dm01_dec_16,
  dm01_jan_17,
  dm01_feb_17,
  dm01_mar_17,
  dm01_apr_17,
  dm01_may_17,
  dm01_jun_17,
  dm01_jul_17,
  dm01_aug_17,
  dm01_sep_17,
  dm01_oct_17,
  dm01_nov_17,
  dm01_dec_17,
  dm01_jan_18,
  dm01_feb_18,
  dm01_mar_18,
  dm01_apr_18,
  dm01_may_18,
  dm01_jun_18,
  dm01_jul_18,
  dm01_aug_18,
  dm01_sep_18,
  dm01_oct_18,
  dm01_nov_18,
  dm01_dec_18,
  dm01_jan_19,
  dm01_feb_19,
  dm01_mar_19,
  dm01_apr_19,
  dm01_may_19,
  dm01_jun_19,
  dm01_jul_19,
  dm01_aug_19,
  dm01_sep_19,
  dm01_oct_19,
  dm01_nov_19,
  dm01_dec_19,
  dm01_jan_20,
  dm01_feb_20,
  dm01_mar_20,
  dm01_apr_20,
  dm01_may_20,
  dm01_jun_20,
  dm01_jul_20,
  dm01_aug_20,
  dm01_sep_20,
  dm01_oct_20,
  dm01_nov_20,
  dm01_dec_20,
  dm01_jan_21,
  dm01_feb_21,
  dm01_mar_21,
  dm01_apr_21,
  dm01_may_21,
  dm01_jun_21
  )

# Plot diagnostic activity
dmo01_union_cavell <-
dmo01_union %>% 
  filter(commissioner_org_code == "05N") %>% # Commissioned by NHS SHROPSHIRE CCG
  filter(diagnostic_tests %!in% c("TOTAL"),
         provider_org_name != "THE SHREWSBURY AND TELFORD HOSPITAL NHS TRUST",
         ) %>% 
  group_by(date, provider_org_name, diagnostic_tests) %>% 
  summarise(activity = sum(total_activity)) %>%
  mutate(cavell_activity = activity * 0.128) %>% # Cavell Centre proporiton of activity
  mutate(provider_org_name = tolower(provider_org_name)) %>% # Lowercase organisation names
  mutate(provider_org_name = simpleCap(provider_org_name)) %>%  # Capitalise organisation name
  mutate(provider_org_name_short = 
           case_when(
             nchar(provider_org_name) > 30 ~ paste0(substr(provider_org_name,1, 30), "..."),
             TRUE ~ provider_org_name
             )) %>% 
  mutate(diagnostic_tests = 
           case_when(
             diagnostic_tests == "AUDIOLOGY_ASSESSMENTS" ~ "Audiology Assessment",
             diagnostic_tests == "BARIUM_ENEMA" ~ "Barium Enema",
             diagnostic_tests == "COLONOSCOPY" ~ "Colonoscopy",
             diagnostic_tests == "CT" ~ "CT",
             diagnostic_tests == "CYSTOSCOPY" ~ "Cystoscopy",
             diagnostic_tests == "DEXA_SCAN" ~ "DEXA Scan",
             diagnostic_tests == "ECHOCARDIOGRAPHY" ~ "ECG",
             diagnostic_tests == "ELECTROPHYSIOLOGY" ~ "Electrophysiology",
             diagnostic_tests == "FLEXI_SIGMOIDOSCOPY" ~ "Flexi sigmoidoscopy",
             diagnostic_tests == "GASTROSCOPY" ~ "Gastroscopgy",
             diagnostic_tests == "MRI" ~ "MRI",
             diagnostic_tests == "NON_OBSTETRIC_ULTRASOUND" ~ "Non-obstetric USS",
             diagnostic_tests == "PERIPHERAL_NEUROPHYS" ~ "Neurophysiology",
             diagnostic_tests == "SLEEP_STUDIES" ~ "Sleep studies",
             diagnostic_tests == "URODYNAMICS" ~ "Urodynamics",
             diagnostic_tests == "Audiology - Audiology Assessments" ~ "Audiology Assessment",
             diagnostic_tests == "Barium Enema" ~ "Barium Enema",
             diagnostic_tests == "Cardiology - echocardiography" ~ "Echocardiography",
             diagnostic_tests == "Cardiology - electrophysiology" ~ "Electrophyiology",
             diagnostic_tests == "Colonoscopy" ~ "Colonoscopy",
             diagnostic_tests == "Computed Tomography" ~ "CT",
             diagnostic_tests == "Cystoscopy" ~ "Cystoscopy",
             diagnostic_tests == "DEXA Scan" ~ "DEXA Scan",
             diagnostic_tests == "Flexi sigmoidoscopy" ~ "Flexi sigmoidoscopy",
             diagnostic_tests == "Gastroscopy" ~ "Gastroscopgy",
             diagnostic_tests == "Magnetic Resonance Imaging" ~ "MRI",
             diagnostic_tests == "Neurophysiology - peripheral neurophysiology" ~ "Neurophysiology",
             diagnostic_tests == "Non-obstetric ultrasound" ~ "Non-obstetric USS",
             diagnostic_tests == "Respiratory physiology - sleep studies" ~ "Sleep studies",
             diagnostic_tests == "Total" ~ "Total",
             diagnostic_tests == "Urodynamics - pressures & flows" ~ "Urodynamics"
           )) %>% 
  ungroup() %>% 
  group_by(provider_org_name_short) %>% 
  #filter(date == max(date))
  mutate(label = 
           case_when(
             date == max(date) ~ diagnostic_tests # Add conditional label on the max date to add to graph
           )) %>% 
  filter(cavell_activity < 1000) %>%  # Fudge to ignore high outlier in Shrewsbury and Telford Hospital 
  ungroup()
## Maternity data ####

birth_episodes <- 
  read_csv("Activity_data_raw/IP_birth_episodes_1620.csv") %>% 
  clean_names() %>% 
  mutate(admission_date = as.Date(admission_date)) %>% 
  filter(age_on_admission > 1) # remove children from birth episodes data

# Annual counts
birth_episodes %>%
  filter(admission_date < "2021-01-01") %>% 
  group_by(substr(episode_start_date,1,4)) %>%
  summarise(birth_episodes = n_distinct(apce_ident)) %>% 
  rename(year = 1) %>% 
  mutate(antenatal_apps = birth_episodes * 8, # Approx. 8 antenatal appointments per pregnancy 
         antenatel_scans = birth_episodes * 3 # Approx 3 antenatal scans per pregnancy
         )

# Monthly count
birth_episodes %>%
  filter(admission_date < "2021-01-01")  %>% 
  group_by(substr(episode_start_date,1,7))%>%
  summarise(birth_episodes = n_distinct(apce_ident)) %>% 
  rename(month = 1) %>%
  mutate(month = paste0(month,"-01")) %>% 
  mutate(month = as.Date(month)) %>% 
  
  ggplot(aes(x = month, y = birth_episodes)) +
  geom_smooth(method = "loess", span = 0.2, colour = "#f9bf07") + 
  labs(x = "Month", y = "Birth episodes",
       title = "Monthly births in Shrewsbury Health and Well-being Hub patients, 2016-19")

# Monthly contacts
ante_natal_contacts <-
birth_episodes %>%
  filter(admission_date < "2021-01-01",
         age_on_admission > 1)  %>% 
  group_by(substr(episode_start_date,1,7))%>%
  summarise(birth_episodes = n_distinct(apce_ident)) %>% 
  rename(month = 1) %>%
  mutate(month = as.Date(paste0(month,"-01"))) %>% 
  mutate(antenatal_apps = birth_episodes * 8, # Approx. 8 antenatal appointments per pregnancy 
         antenatel_scans = birth_episodes * 3 # Approx 3 antenatal scans per pregnancy
  )

# Daily contacts
ante_natal_contacts_daily <-
  birth_episodes %>%
  filter(admission_date < "2021-01-01",
         age_on_admission > 1)  %>% 
  group_by(episode_start_date)%>%
  summarise(birth_episodes = n_distinct(apce_ident)) %>% 
  rename(date = 1) %>%
  mutate(antenatal_apps = birth_episodes * 8, # Approx. 8 antenatal appointments per pregnancy 
         antenatel_scans = birth_episodes * 3 # Approx 3 antenatal scans per pregnancy
         )

# Daily count
birth_episodes %>%
  filter(admission_date < "2021-01-01")  %>% 
  group_by(episode_start_date)%>%
  summarise(birth_episodes = n_distinct(apce_ident)) %>% 

  ggplot(aes(x = episode_start_date, y = birth_episodes)) +
  geom_smooth(method = "loess", span = 0.2, colour = "#f9bf07") + 
  labs(x = "Episode date", y = "Birth episodes",
       title = "Daily births in Shrewsbury Health and Well-being Hub patients, 2016-19")

## Phase 1 output - Phase 2 input (?) ####
# Transform activity into uniform structure - monthly volumes 

# GP consultations 

# Maternity 

# Diagnostic 
diagnostics_cavell <-
  dmo01_union_cavell %>% 
  mutate(month = as.Date(paste0(substr(date, 1,7), "-01"))) %>% 
  mutate(diag_test_group = 
           case_when(
             diagnostic_tests == "CT" ~ diagnostic_tests,
             diagnostic_tests == "MRI" ~ diagnostic_tests,
             diagnostic_tests == "ECG" ~ diagnostic_tests,
             diagnostic_tests == "Non-obstetric USS" ~ "USS",
             diagnostic_tests == "Echocardiography" ~ "Echo",
             diagnostic_tests == "Flexi sigmoidoscopy" ~ "Flexi_sig",
             TRUE ~ "Other"
           )) %>% 
  #select(diagnostic_tests, diag_test_group) %>% distinct()
  group_by(month, diag_test_group) %>% 
  summarise(cavell_activity = sum(cavell_activity)) %>% 
  mutate(diag_test_group = paste0("diag_", diag_test_group)) %>% 
  
  pivot_wider(id_cols = month, 
              names_from = diag_test_group,
              values_from = cavell_activity) %>% 
  clean_names()


# Daily diagnostic data? - Downloaded in monthly returns
diagnostics_cavell_daily <-
  diagnostics_cavell %>% 
  mutate(diag_ct = diag_ct/30,
         diag_ecg = diag_ecg/30,
         diag_flexi_sig = diag_flexi_sig/30,
         diag_mri = diag_mri/30,
         diag_other = diag_other/30,
         diag_uss = diag_uss/30,
         diag_echo = diag_echo/30
         )

# MH 
mh_phase_2_input <-
  mhsds_contacts_1620 %>% 
  filter(location_type_group != "Inpatient") %>% 
  filter(team_service_desc %!in% c(
    "Forensic Mental Health Service",
    "Prison Psychiatric Inreach Service")) %>%  # Exclusions from Ian Chan
  mutate(month = as.Date(paste0(substr(care_cont_date,1,7),"-01"))) %>% 
  group_by(month, location_type_group) %>% 
  summarise(contact_count = n_distinct(care_contact_id)) %>% 
  mutate(location_type_group = paste0("MH_", location_type_group)) %>% 
  pivot_wider(id_cols = month,
              names_from = location_type_group,
              values_from = contact_count) %>% 
  clean_names()

mh_phase_2_input_daily <-
  mhsds_contacts_1620 %>% 
  filter(location_type_group != "Inpatient") %>% 
  filter(team_service_desc %!in% c(
    "Forensic Mental Health Service",
    "Prison Psychiatric Inreach Service")) %>%  # Exclusions from Ian Chan
  #mutate(month = as.Date(paste0(substr(care_cont_date,1,7),"-01"))) %>% 
  group_by(care_cont_date, location_type_group) %>% 
  summarise(contact_count = n_distinct(care_contact_id)) %>% 
  rename(date = 1) %>% 
  mutate(location_type_group = paste0("MH_", location_type_group)) %>% 
  pivot_wider(id_cols = date,
              names_from = location_type_group,
              values_from = contact_count) %>% 
  clean_names()

# IAPT
# All referral teams included - data split into face-to-face and other consultation medium
iapt_phase_2_input <-
  iapt %>%
  mutate(month = as.Date(paste0(substr(appointment,1,7), "-01"))) %>% 
  group_by(month, cons_medium_group) %>% 
  summarise(n = n_distinct(appointment_id)) %>% 
  mutate(cons_medium_group = paste0("IAPT_", cons_medium_group)) %>% 
  pivot_wider(id_cols = month, 
              names_from = cons_medium_group,
              values_from = n) %>% 
  clean_names()

# IAPT Daily 
iapt_phase_2_input_daily <-
  iapt %>%
  #mutate(month = as.Date(paste0(substr(appointment,1,7), "-01"))) %>% 
  group_by(appointment, cons_medium_group) %>% 
  summarise(n = n_distinct(appointment_id)) %>% 
  rename(date = 1) %>% 
  mutate(cons_medium_group = paste0("IAPT_", cons_medium_group)) %>% 
  pivot_wider(id_cols = date, 
              names_from = cons_medium_group,
              values_from = n) %>% 
  clean_names()

# OPA - Dictated by imaging capacity of centre - awaiting feedback from Board meeting... 
opa_phase_2_input <-
  opa_colated %>% 
  filter(attendance_type != "Attendance - Multi professional") %>% 
  mutate(month = as.Date(paste0(substr(appointment_date,1,7), "-01")))  %>% 
  group_by(month, imaging) %>% 
  summarise(opa_contacts = n_distinct(opa_ident)) %>% 
  arrange(month) %>%
  mutate(imaging = paste0("opa_", imaging)) %>% 
  pivot_wider(id_cols = month, 
              names_from = imaging,
              values_from = opa_contacts) %>% 
  clean_names()

# OPA daily
opa_phase_2_input_daily <-
  opa_colated %>% 
  filter(attendance_type != "Attendance - Multi professional") %>% 
 # mutate(month = as.Date(paste0(substr(appointment_date,1,7), "-01")))  %>% 
  group_by(appointment_date, imaging) %>% 
  summarise(opa_contacts = n_distinct(opa_ident)) %>% 
  rename(date = 1) %>% 
  arrange(date) %>%
  mutate(imaging = paste0("opa_", imaging)) %>% 
  pivot_wider(id_cols = date, 
              names_from = imaging,
              values_from = opa_contacts) %>% 
  clean_names()
  
  
# Community care - How to include domiciliary contacts? We want to include space required for service relocation
ShropCom_phase_2_input <-
  ShropCom_contacts_refs %>% 
  # Exclusions from clinicians 
  filter(ActivityLocationTypeGroup %in% c(
    "Primary care", 
    "Secondary care",
    "Community")) %>% 
  mutate(month = as.Date(paste0(substr(carecontactdate,1,7), "-01"))) %>%
  group_by(month) %>% 
  summarise(care_contacts = n_distinct(carecontactid)) %>% 
  arrange(month) %>% 
  rename(shropcom_contacts = care_contacts)

ShropCom_phase_2_input_domiciliary <-
  ShropCom_contacts_refs %>% 
  filter(ActivityLocationTypeGroup %in% c("Domiciliary")) %>% 
  mutate(month = as.Date(paste0(substr(carecontactdate,1,7), "-01"))) %>%
  group_by(month) %>% 
  summarise(care_contacts = n_distinct(carecontactid)) %>% 
  arrange(month) %>% 
  rename(shropcom_domiciliary_contacts = care_contacts)

# Shropcom daily
ShropCom_phase_2_input_daily <-
  ShropCom_contacts_refs %>% 
  # Exclusions from clinicians 
  filter(ActivityLocationTypeGroup %in% c(
    "Primary care", 
    "Secondary care",
    "Community")) %>% 
  #mutate(month = as.Date(paste0(substr(carecontactdate,1,7), "-01"))) %>%
  group_by(carecontactdate) %>% 
  summarise(care_contacts = n_distinct(carecontactid)) %>% 
  rename(date = 1) %>% 
  arrange(date) %>% 
  rename(shropcom_contacts = care_contacts)


# Social care - awaiting data from Shropshire council or space allocation to assume volume from


# Phase 2 input
# Monthly
phase_2_input <-
  ante_natal_contacts %>% 
  select(-birth_episodes) %>% 
  left_join(
    consultations_cavell %>% 
      mutate(month = as.Date(paste0(substr(appointment_date, 1,7), "-01"))) %>% 
      group_by(month) %>% 
      summarise(GP_consultations = sum(cavell_appts)),
    by = c("month")) %>%
  select(1,4,2,3) %>% 
  left_join(diagnostics_cavell, by = c("month")) %>% 
    # Check - what diagnostic activity will be included/excluded - equipment driven?
    # Check - Will activity from all 3 providers be taken on in Cavell Centre?
  left_join(mh_phase_2_input, by = c("month")) %>% 
    # Check whether 'Community' cases should be in there?
  left_join(iapt_phase_2_input, by = c("month")) %>% 
  left_join(ShropCom_phase_2_input, by = c("month")) %>% 
  left_join(ShropCom_phase_2_input_domiciliary, by = c("month")) %>% 
  left_join(opa_phase_2_input, by = c("month")) %>% 
  pivot_longer(cols = -month) %>% 
  mutate(value = replace_na(value, 0)) %>% 
  pivot_wider(id_cols = month) 

phase_2_input <-
  phase_2_input %>% 
  mutate(total_activity =  
           rowSums(phase_2_input[,-1])
           #mutate_if(is.numeric, sum, na.rm=TRUE)
           ) %>% 
  mutate(ASC_place_holder = total_activity * 0.05) %>% # 5% of total activity allocated to ASC
  select(-total_activity)

# Daily 
phase_2_input_daily <-
  ante_natal_contacts_daily %>% 
  select(-birth_episodes) %>% 
  left_join(
    consultations_cavell %>% 
      group_by(appointment_date) %>% 
      summarise(GP_consultations = sum(cavell_appts)),
    by = c("date" = "appointment_date")) %>%
  select(1,4,2,3) %>%
  mutate(month = as.Date(paste0(substr(date, 1,7), "-01"))) %>% 
  left_join(diagnostics_cavell_daily, by = c("month")) %>% 
  select(-month) %>% 
  left_join(mh_phase_2_input_daily, by = c("date")) %>% 
  left_join(iapt_phase_2_input_daily, by = c("date")) %>% 
  left_join(ShropCom_phase_2_input_daily, by = c("date")) %>% 
  left_join(opa_phase_2_input_daily, by = c("date")) %>% 
  pivot_longer(cols = -date) %>% 
  mutate(value = replace_na(value, 0)) %>% 
  pivot_wider(id_cols = date)

```

# Background/Project Details
## Combined patient population health service needs
The first strand of our analysis will be to collate and summarise GP surgery patient lists for the given 8 practices. This will be achieved using publicly available data from NHS Digital, specifically data on the distribution of GP patients by gender, sex and LSOA along with the number of patients each practice has with selected health conditions specified by Quality Outcome Framework (QOF) returns.
Without access to individual level GP data, we will not be able to account for multi-morbidity, that is, we will present the combined volume of patients across the 8 practices who are know to have heart disease for example, alongside the number of COPD, but not the number with both conditions. 
We will also estimate the volume and nature of referrals to community care for this combined patient population. A preliminary data query, using our Community Services Data Set would suggest our combined population were responsible for approximately 130,000 referrals to community services during 2019, primarily for footcare, MSK problems and the ‘Healthy Child Pathway’. Discussions will be required to agree the most appropriate method of estimating ‘existing’ demand given changes to referrals and care seeking behaviour throughout the pandemic. 
This exercise will provide high level estimates of demographics and clinical need for the new patient population and will serve as a baseline to feed into our model when predicting wider service engagement and demand.
To complete this analysis, we will also identify activity across other aspects of the health and care system used by patients at the 8 practices according to the Shrewsbury Health and Well-being Hub service model. This will include but is not necessarily restricted to:

 *	Outpatient appointments at RSH, PRH and other acute providers
 *	Appointments/rehab/therapies at RJAH/ShropCom
 *	Appointments/assessments/therapies at MPFT and other mental health providers
 *	Diagnostics at SaTH/RJAH/ShropCom
 *	Midwifery and antenatal care
 *	Any others from ‘service spec’
 
 The programme team will need to provide definitions of all the activity types and clinical areas that are relevant to the Shrewsbury Health and Well-being Hub model for each of the above points of delivery so that only relevant data is extracted and counted.


# Population demographics

## Practice populations

**Combined practices patient total:**
```{r GP list size}
create_dt(
  b_practice_pop_pyramid %>%  
  summarise(Male = sum(male_patient_count),
            Female = sum(female_patient_count)) %>% 
  mutate(total = sum(Male, Female)) %>% 
  mutate(Population = "Combined") %>% 
  select(4,1:3)
)
```

**Practice list size:**
```{r GP combined list size}
create_dt(
b_practice_pop_pyramid %>% 
  group_by(practice_name) %>% 
  summarise(Male = sum(male_patient_count),
            Female = sum(female_patient_count)) %>% 
  mutate(Total = Male + Female) %>% 
  rename(Practice = practice_name) %>% 
  arrange(desc(Total))
)
```


```{r Patient population over time}
# NHS digital 
a <-
prac_pop_monthly %>%
  left_join(a_practice_mapping %>% 
              select(practice_code, practice_name), by = c("code" = "practice_code")) %>% 
  mutate(label = case_when(extract_date == "2021-05-01" ~ practice_name)) %>% 

  ggplot(aes(x = extract_date, 
             y = number_of_patients, 
             group = practice_name, 
             colour = practice_name,
             label = label)) +
  geom_smooth(method = "loess", span = 0.5) +
  geom_label_repel(size = 2.5,  box.padding = 0.5) +
  scale_color_SU() +
  theme(legend.position = "none",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +
  labs(x = "Year", y = "Patient count", colour = "",
       title = "",
       subtitle = "Practice-specific",
       caption = "")

b <-
prac_pop_monthly %>% 
  group_by(extract_date) %>% 
  summarise(count = sum(number_of_patients)) %>% 
  
  ggplot(aes(x = extract_date, y = count)) +
  geom_smooth(method = "loess", span = 0.5, colour = "#f9bf07") +
  ylim(55000,70000) +
  theme(legend.position = "none",
        plot.subtitle = element_text(hjust = 0.5, face = "bold")) +
  labs(x = "Year", y = "Patient count", colour = "",
       title = "",
       subtitle = "Combined patient population",
       caption = "")

# Patch together
a + b +
  plot_layout(widths = c(0.65,0.35)) +
  plot_annotation(
    title = "Practice patient count over time, 2018-21",
    subtitle = "Changes in patient population from 8x practices included in Shrewsbury Health and Well-being Hub planning",
    caption = 'Source: NHS Digital - Patients registered at a GP Practice'
  )
```

While practices differ in size/patient capacity, changes over time have been largely consisent between practices. All have seen gradual increases in patient population between 2013 and 2020.  

## Age and gender structure 

```{r Patient population pyramid}
(
  b_practice_pop_pyramid %>% 
    group_by(age) %>% 
    summarise(male = sum(male_patient_count),
              female = sum(female_patient_count)) %>% 
    mutate(male_neg = -male) %>% 
    pivot_longer(cols = -age,
                 names_to = "gender",
                 values_to = "count") %>% 
    filter(gender != "male") %>% 
    mutate(gender = case_when(
      gender == "female" ~ "Female",
      gender == "male_neg" ~ "Male",
      TRUE ~ "NA"
    )) %>% 
    
    ggplot(aes(y = count, x = age, fill = gender)) +
    geom_col(width = 1) +
    coord_flip() +
    scale_y_continuous(breaks = c(-300,0,300), labels = c("300","0","300")) + 
    scale_fill_SU(palette = "main") +
    theme(strip.text = element_text(face = "bold"),
          legend.position = "none",
          plot.subtitle = element_text(hjust = 0.5, face = "bold")
    ) +
    labs(y = "Patient count",
         x = "Age", 
         fill = "",
         title = "",
         subtitle = "Combined patient population")
) +
  (
    b_practice_pop_pyramid %>% 
      pivot_longer(cols = c(-org_code, -practice_name, -age),
                   names_to = "gender",
                   values_to = "count") %>% 
      filter(gender != "male_patient_count",
             age != "ALL") %>% 
      mutate(gender = case_when(
        gender == "female_patient_count" ~ "Female",
        gender == "male_patient_count_neg" ~ "Male",
        TRUE ~ "NA"
      )) %>% 
      
      ggplot(aes(y = count, x = age, fill = gender)) +
      geom_col(width = 1) +
      facet_wrap(~practice_name) +
      coord_flip() +
      scale_y_continuous(breaks = c(-100,0,100), labels = c("100","0","100")) + 
      scale_fill_SU(palette = "main") +
      theme(strip.text = element_text(face = "bold", size = 8),
            legend.position = c(0.85, 0.2)) +
      labs(y = "Patient count",
           x = "Age", 
           fill = "",
           title = "",
           subtitle = "")
    ) +
  plot_layout(widths = c(0.4,0.6)) +
  plot_annotation(
    title = 'Combined and practice-specific patient population by age and gender, June 2021',
    subtitle = 'Patient population from 8x practices included in Shrewsbury Health and Well-being Hub planning',
    caption = 'Source: NHS Digital - Patients registered at a GP Practice'
  )
```

The age and gender profiles are largely similar and a function of local demographics; we can see differing patient volumes but similar proportions of 50+ year old patients across all practices. Mytton Oak displays a particularly large count of under 25's compared to other practices however this has little impact of the profile of the combined patient population.

## Deprivation 

```{r Patient proportion by deprivation}
(
practice_pop_imd_decile %>% 
  group_by(imd_decil) %>% 
  summarise(comb_count = sum(count)) %>% 
  drop_na(imd_decil) %>% 
  mutate(prop = comb_count/sum(comb_count)*100) %>% 
  
  ggplot(aes(x = imd_decil, y = prop)) +
    geom_vline(xintercept = 5, linetype = "dashed") +
    geom_col(fill = "#f9bf07", colour = "grey") +
    scale_x_continuous(limits = c(0, 11), breaks = seq(1, 10, by = 1)) +
    scale_fill_SU(palette = "main") +
    theme(legend.position = "none",
          plot.subtitle = element_text(hjust = 0.5, face = "bold")
          ) +
    labs(y = "Proportion of patients",
         x = "IMD Decile", 
         title = "",
         subtitle = "Combined patient population")
  ) +
  (
    practice_pop_imd_decile %>% 
      ggplot(aes(x = imd_decil, y = prop)) +
      geom_vline(xintercept = 5, linetype = "dashed") +
      geom_col(fill = "#f9bf07", colour = "grey") +
      facet_wrap(~practice_name) +
      scale_x_continuous(limits = c(0, 11), breaks = seq(1, 10, by = 1)) +
      theme(strip.text = element_text(face = "bold", size = 8)) +
      labs(y = "Patient count",
           x = "IMD Decile ", 
           fill = "",
           title = "",
           subtitle = "")
    ) +
  plot_layout(widths = c(0.4,0.6)) +
  plot_annotation(
    title = 'Combined and practice-specific patient population by Index of Multiple Deprivation (IMD) Decile, June 2021',
    subtitle = 'Patient population from 8x practices included in Shrewsbury Health and Well-being Hub planning',
    caption = 'IMD decile 1: Most deprived 10% of the populaton. IMD decile 10: Most affluent 10% of the population'
  )

```

The above graph suggests relatively low levels of deprivation in the Shrewsbury Health and Well-being Hub patient population with the majority of patients living in more affluent areas of the country. The deprivation level of a patient here is a function of their LSOA of residence; this is not an individual level statistic and as such there may be highly deprived patients, in relative or absolute terms, living in the catchment area.

Local authority data and/or population segmentation tools such as Acorn may educate the analysis to small areas of localised deprivation in the combined population.

```{r}
## Add acorn data to show pockets of deprivation?
Acorn_pop_seg <- 
  read_excel("Acorn_population_segmentation.xlsx", skip = 6) %>% 
  clean_names() %>% 
  filter(type_description != "Total")

# Category 
Acorn_pop_seg %>%
  mutate(cavell_centre_gp_population_prop = cavell_centre_gp_population/sum(cavell_centre_gp_population)*100) %>% 
  select(1:4, contains("prop")) %>% 
  pivot_longer(cols = c(-category, -group, -type, -type_description)) %>% 
  group_by(category, name) %>% 
  summarise(value = sum(value)) %>%
  ungroup() %>% 
  mutate(order = replace(min_rank(value), category == "Category 1: Affluent Achievers", 0)) %>% 
  mutate(alpha = 
           case_when(name == "cavell_centre_gp_population_prop" ~ "Y",
                     TRUE ~ "N")) %>% 
  mutate(practice = 
           case_when(
             name == "beeches_medical_practice_prop" ~ "Beeches MP",
             name == "belvidere_medical_pract_prop" ~ "Belvidere MP",
             name == "cavell_centre_gp_population_prop" ~ "Cavel Centre Population",
             name == "claremont_bank_surgery_prop" ~ "Claremont Bank",
             name == "marden_medical_practice_prop" ~ "Marden MP",
             name == "marysville_medical_pract_prop" ~ "Marysville MP",
             name == "mytton_oak_medical_pract_prop" ~ "Mytton Oak MP",
             name == "radbrook_green_surgery_prop" ~ "Radbrook Green Surgery",
             name == "south_hermitage_surgery_prop" ~ "South Hermitage Surgery"
           )) %>% 
  
  ggplot(aes(x = reorder(practice, order), y = value, fill = category, alpha = alpha)) +
  geom_col() +
  coord_flip() +
  scale_fill_SU(palette = "main") +
  scale_alpha_manual(values = c(0.5, 1), guide = "none") +
  labs(x = "Practice",
       y = "Proportion of patient population",
       fill = "Acorn Category",
       title = "Shrewsbury Health and Well-being Hub GP population by Acorn population segmentation",
       subtitle = "Proportion of practice registered population by Acorn population segmentation 'Category', 2019")
```



# Clinical profiles

## QOF derived 
```{r Combined prevalence of QOF diseases}
# Prevalence
phe_clinical_indicators_qof_comb %>% 
  inner_join(qof_indicator_desc, by = c("indicator_id")) %>% 
  mutate(group = factor(group, levels = c("CVD", "Resp", "General", "MH"))) %>% 
  
  ggplot(aes(x = time_period, y = comb_value, group = 1, colour = group)) +
  geom_smooth() +
  facet_wrap(~desc, scales = "free") +
  scale_color_SU() +
  theme(axis.text.x = element_text(angle = 90, size = 7.5),
        axis.text.y = element_text(size = 7.5),
        strip.text = element_text(face = "bold")) +
  labs(x = "Date", y = "Prevalence (%)", colour = "Disease group",
       title = "QOF disease prevalence",
       subtitle = "Changing prevalence of selected disease groups in Shrewsbury Health and Well-being Hub practices, 2015/16-19/20",
       caption = "Source: PHE Fingertips - GP Profiles, QOF returns")

```


## Practice data 

Practice data will offer insight on the volume and rate of patients with comorbidities as well as appointment type, duration and staffing to inform phase 2 modelling.

# Consultation data 

Consultation data is available from NHS Digital at: <https://digital.nhs.uk/data-and-information/publications/statistical/appointments-in-general-practice> 

Lowest geography data is available at is CCG; as such we assess the age and gender profile of our 8 practices against that of the wider CCG (excluding our patients) to decide if we can directly discount CCG values by the proportion our patients represent and assume similar care utilisation.  

```{r Age and gender profiles - Cavell pop vs rest of CCG}
STW_practices_external_flag_long %>%
  ggplot(aes(x = age, y = value, fill = name)) +
  geom_col(width = 1) +
  coord_flip() +
  facet_wrap(~external) +
  scale_y_continuous(breaks = c(-0.5,0,0.5), labels = c("0.5","0","0.5")) + 
  scale_fill_SU(palette = "main") +
  theme(strip.text = element_text(face = "bold")
  ) +
  labs(y = "Patient proportion",
       x = "Age", 
       fill = "",
       title = "Population stucture of Shrewsbury Health and Well-being Hub patients is similar to wider CCG patients",
       subtitle = "NHS Shropshire and Telford and Wrekin CCG Patient population by age and gender, June 2021 ",
       caption = 'Source: NHS Digital - Patients registered at a GP Practice')

```


```{r Cavel centre as a proportion of wider CCG}
create_dt(
STW_practices_external_flag %>%
 group_by(external) %>% 
 summarise(male_sum = sum(male_count),
           female_sum = sum(female_count)) %>% 
 group_by(external) %>% 
 mutate(total = sum(male_sum, female_sum)) %>% 
 select(external, total) %>% 
 ungroup() %>% 
 mutate(prop = round(total/sum(total)*100,1))
)
```

Shrewsbury Health and Well-being Hub patient population accounts for 12.8% of CCG patients/consultations. Having multiplied CCG-level, monthly consultation counts by 0.128, we can estimate the volumes attributed to the 8 Shrewsbury Health and Well-being Hub practices.

```{r Consultation rate}
consultations_cavell %>% 
  mutate(month = as.Date(paste0(substr(appointment_date, 1,7), "-01"))) %>% 
  group_by(month) %>% 
  summarise(n = sum(cavell_appts)) %>% 
  ggplot(aes(x= month, y = n)) +
  annotate("rect", xmin = as.Date("2020-03-23"), xmax = as.Date("2020-07-04"), 
           ymin = -Inf, ymax = Inf, fill= "#fed976", alpha = 0.8) + # Lockdown 1
  annotate("rect", xmin = as.Date("2020-10-14"), xmax = as.Date("2021-01-04"), 
           ymin = -Inf, ymax = Inf, fill= "#fed976", alpha = 0.8) + # 3 tier system
  annotate("text", x = as.Date("2020-05-13"), y = 30000, label = "National lockdown",
           size = 3, angle = 90, colour = "#2c2825") +
  annotate("text", x = as.Date("2020-11-24"), y = 30000, label = "3 Tier lockdown",
           size = 3, angle = 90, colour = "#2c2825") +
  geom_smooth(method = "loess", span = 0.5, colour = "#f9bf07") +
  scale_y_continuous(labels = scales::comma) +
  scale_color_SU() +
  labs(x = "Date", y = "Monthly count", colour = "Appointment mode",
       title = "Consultation rate in Shrewsbury Health and Well-being Hub practices",
       subtitle = "Shropshire and Telford and Wrekin CCG consultation counts discounted to Shrewsbury Health and Well-being Hub patient population",
       caption = "Source: NHS Digital - Appointments in General Practice")

```
<br>
Primary care consultation data is available to describe primary care activity by contact medium, health professional and the duration of time between booking an appointment and being seen. Above we can see the impact of the covid-19 pandemic on consultation rates in primary care in our 8x GP practices. Pre-pandemic levels were consistently around 27k appointments per month. Rates have not returned to pre-pandemic levels yet. 
<br>
Below the impact of the pandemic on consultation medium is made clear; we see a significant and sustained reduction in face-to-face consultations and a subsequent increase in telephone consultations as care was shifted to virtual delivery. Interestingly, we also see a post-pandemic increase in the rate at which patients are seen on the same day as their booking; perhaps linked to reduced consultations occurring overall or an emphasis on early contact screening to rule out covid-19.
<br>
<br>

```{r Consultations by appointment mode}
(
# Appointment mode
consultations_cavell %>% 
  group_by(appointment_date, appt_mode) %>% 
  summarise(n = sum(cavell_appts)) %>% 
  ggplot(aes(x=appointment_date, y = n, colour = appt_mode)) +
  annotate("rect", xmin = as.Date("2020-03-23"), xmax = as.Date("2020-07-04"), 
           ymin = -Inf, ymax = Inf, fill= "#fed976", alpha = 0.8) + # Lockdown 1
  annotate("rect", xmin = as.Date("2020-10-14"), xmax = as.Date("2021-01-04"), 
           ymin = -Inf, ymax = Inf, fill= "#fed976", alpha = 0.8) + # 3 tier system
  annotate("text", x = as.Date("2020-05-13"), y = 800, label = "National lockdown",
           size = 3, angle = 90, colour = "#2c2825") +
  annotate("text", x = as.Date("2020-11-24"), y = 800, label = "3 Tier lockdown",
           size = 3, angle = 90, colour = "#2c2825") +
  geom_smooth(method = "loess", span = 0.5) +
  scale_color_SU() +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 8),
    plot.title = element_text(hjust = 0.5, size = 10)
    ) +
  guides(color=guide_legend(nrow=2, byrow=TRUE)) +
  labs(x = "", y = "Count", colour = "", title = "Appointment mode")
) +
  (
# Time between booking and appointment
consultations_cavell %>% 
  filter(time_between_book_and_appt != "Unknown / Data Issue") %>% 
  group_by(appointment_date, time_between_book_and_appt) %>% 
  summarise(n = sum(cavell_appts)) %>% 
  ggplot(aes(x=appointment_date, y = n, colour = time_between_book_and_appt)) +
  annotate("rect", xmin = as.Date("2020-03-23"), xmax = as.Date("2020-07-04"), 
           ymin = -Inf, ymax = Inf, fill= "#fed976", alpha = 0.8) + # Lockdown 1
  annotate("rect", xmin = as.Date("2020-10-14"), xmax = as.Date("2021-01-04"), 
           ymin = -Inf, ymax = Inf, fill= "#fed976", alpha = 0.8) + # 3 tier system
  annotate("text", x = as.Date("2020-05-13"), y = 300, label = "National lockdown",
           size = 3, angle = 90, colour = "#2c2825") +
  annotate("text", x = as.Date("2020-11-24"), y = 300, label = "3 Tier lockdown",
           size = 3, angle = 90, colour = "#2c2825") +
  geom_smooth(method = "loess", span = 0.3) +
  scale_color_SU() +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 8),
    plot.title = element_text(hjust = 0.5, size = 10)
    ) +
  guides(color=guide_legend(nrow=3, byrow=TRUE)) +
  labs(x = "Date", y = "Count", colour = "", title = "Time between booking appointment and contact")
) +
  plot_annotation(
    title = "Changing count of consultations in Shrewsbury Health and Well-being Hub practices",
    subtitle = "NHS Shropshire and Telford and Wrekin CCG consultation counts discounted to Shrewsbury Health and Well-being Hub GP patient population"
    )

```

# Outpatient care

```{r OPA profiles}
a <-
opa_by_speciality %>% 
  filter(der_financial_year == "2019/20") %>% 
  group_by(speciality) %>% 
  summarise(n = sum(opa_count)) %>% 
  arrange(desc(n)) %>% 
  mutate(prop = n/sum(n)*100) %>% 
  filter(speciality != "#N/A") %>% 
  top_n(10) %>% 
  
  ggplot(aes(x = prop, y = reorder(speciality, prop), fill = speciality)) +
  geom_col() +
  scale_fill_SU(palette = "mixed", guide = "none") +
  theme(plot.subtitle = element_text(hjust = 0.3, face = "bold")) +
  labs(x = "OPA proportion",
       y = "Speciality", 
       title = "", 
       subtitle = "Combined population")
             
b <-
opa_by_speciality %>%
  filter(der_financial_year == "2019/20",
         speciality != "#N/A") %>%
  mutate(speciality = case_when(
    nchar(speciality) > 20 ~ paste0(substr(speciality,1,20),"..." ),
    TRUE ~ speciality)) %>% 
  group_by(practice_name) %>% 
  mutate(practice_total = sum(opa_count)) %>% 
  mutate(prop_practice_total = opa_count/practice_total*100) %>% 
  top_n(10, prop_practice_total) %>% 
  mutate(row_number = row_number(-prop_practice_total)) %>% 
  ungroup() %>% 
  
  ggplot(aes(x = -row_number, y = prop_practice_total, fill = speciality)) +
  geom_col(show.legend = TRUE) +
  coord_flip() +
  facet_wrap(~practice_name) +
  scale_fill_SU(palette = "mixed") +
  guides(fill=guide_legend(ncol=1)) +
  theme(legend.position = c(0.85, 0.15),
        legend.key.size = unit(0.05, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.text = element_text(size = 7),
        axis.text.y = element_blank(),
        axis.ticks.y =element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(size = 8, face = "bold")) +
  labs(y = "OPA proportion",
       x = "Speciality",
       fill = "",
       title = "",
       subtitle = "")

a + b + plot_layout(widths = c(0.3, 0.7)) +
  plot_annotation(
    title = 'Outpatient care profile is very similar between practices',
    subtitle = 'Proportion of outpatient appointments by medical/surgical speciality, Shrewsbury Shrewsbury Health and Well-being Hub GP patients, 2019/20',
    caption = 'Source: SUS outpatient records, accessed via NCDR'
  )
```

It is clear that the high volume specialities are consistent across all 8 practices considering co-location; specifically: 

- Trauma and Orthopaedics, 
- General medicine, 
- Opthamology and 
- General Surgery.

<br>
The sankey diagram below indicates outpatient attendance volume of patients from the Shrewsbury Health and Well-being Hub practices in 2019. Outpatient activity was considered in these terms to identify care unsuitable to collocate in primary care. Most outpatient activity does not require imaging equipment and is therefore suitable for collocation.

```{r}
opa_sankey %>% 
  hc_title(text = "Outpatient activity by appointment descriptor", align = "left") %>% 
  hc_subtitle(text = "Secondary outpatient activity associated to Shrewsbury Health and Well-being Hub patients, 2019", align = "left") %>% 
  hc_caption(text = "Note: Appointments include all ages and specialities") %>% 
  hc_add_theme(hc_theme_flat())
```

An outpatient appointment was defined as an: **attendance** having a HRG code of 'WF01' or 'WF02' (Non-Admitted Attendance) or as a **procedure ** having a procedure code from the below list: 

  - Y981: Radiology of one body area 
  - U131: Bone densitometry
  - U132: Ultrasound of bone
  - U133: Magnetic resonance imaging of body
  - U214: Single photon emission computed
  - U216: Ultrasound scan NEC
  - U183: Mammography
  - U212: Computed tomography NEC
  - U211: Magnetic resonance imaging NEC
  - U012: Magnetic resonance imaging 
  - Y973: Radiology with post contrast
  - U011: Computed tomography of whole body
  - **Or no imaging**
  

**Appointments suitable for collocation include:** 

- Adult and child appointments 
- Both high and low volume specialities 
- First and Follow-up appointments 
- Appointments classified as 'Attendances' and 'Procedures' 
- Appointments that involved imaging (incl. CT, MRI, X-ray and USS)

**Outpatient appointments not suitable include:** 

- Attendances that required multiple professionals from more than one specialty 


# Community care

## Shropshire Community Health NHS Trust (ShropCom) 

Data accessed suggests patients from the 8 practices considering co-location are responsible for **415,467** referrals to ShropCom for community care in the 2-year period between 2018-19.

Referrals will be organised by reason for referral and therefore care type to identify pathways that may be suitable for co-location.

```{r ShropCom referrals table}
create_dt(
ShropCom_refs_1620 %>%
  filter(substr(referralreqrecdate,1,4) == "2019") %>% 
  group_by(reason_for_referral_to_community_care_description_short) %>% 
  summarise(Referrals = n(),
            Individuals = n_distinct(patient_id),
            Ref_per_person = round(n()/n_distinct(patient_id),1),
            Ratio = round(n_distinct(patient_id)/n(),3)) %>% 
  arrange(desc(Referrals)) %>% 
  rename(Reason_referral = reason_for_referral_to_community_care_description_short) %>% 
  filter(Reason_referral != 'NULL') %>% 
  head(10)
)
```


**Community care contacts pathways for Shrewsbury Health and Well-being Hub patients, 2019. ** 

Contacts classified by the following variables:

$~~~~~~~$ **All** $~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~$ **Age** $~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~$ **Contact medium** $~~~~~~~~~~~~~$ **Contact description**    

```{r Community care contacts sankey}
sankeyNetwork(Links = ShropCom_contact_links, 
              Nodes = ShropCom_contacts_nodes,
              Source = "source",
              Target = "target",
              Value = "care_contacts",
              NodeID = "to_value", #Merged field with node name and contact count
              nodeWidth = 15,
              unit = "care contacts", 
              fontSize = 12,
              fontFamily = "sans-serif"
              )
```

Contact activity codes are grouped as follows: 

```{r}
create_dt(
    tribble(
    ~Code, ~Activity_type, ~Activity_group,
    "01", "Administering Tests", "Assessment/Tests",
    "02", "Assessment", "Assessment/Tests",
    "03", "Clinical Intervention", "Clinical Intervention",
    "04", "Counselling, Advice, Support", "Other",
    "05", "Patient Specific Health Promotion", "Other",
    "06", "Multidisciplinary Team Review", "Other",
    "07", "Supporting Another Clinician", "Other",
    "08", "Health Visitor  New Birth Visit", "Health visitor",
    "09", "Health Visitor  Health Review (6-8 weeks)", "Health visitor",
    "10", "Health Visitor Health Review (1 year)", "Health visitor",
    "11", "Health Visitor  Health Review (2-2.5 years)", "Health visitor",
    "12", "Health Visitor Formal handover to School Nursing Service (4-5 years)", "Health visitor",
    "97", "Other (not listed)", "Other"
    )
)
```

**Source**: <https://datadictionary.nhs.uk/data_elements/community_care_activity_type.html> 


**Contacts suitable for collocation include:** 

- Care contacts in adults and children
- Contacts delivered face-to-face and remotely
- Contact functions including "Assessment/Tests", "Clinical intervention", "Health visitor", "Other" and "Unknown"
- All reason for referral codes (Wound care, mobility issues etc) were deemed suitable
- Contacts occurring in Primary care, Secondary care and the Community

**Community contacts excluded are:**

- Contacts occurring in Education or childcare settings, Polyclinics or "Other" settings.

Contacts occurring in domiciliary settings were included in the model but identified as not requiring a clinical room. 


# Diagnositic

Data available at: <https://www.england.nhs.uk/statistics/statistical-work-areas/diagnostics-waiting-times-and-activity/monthly-diagnostics-waiting-times-and-activity/monthly-diagnostics-data-2021-22/>

Data is published at CCG level so a Shrewsbury Health and Well-being Hub derived figure was calculated by assuming similar diagnostic activity between Shrewsbury Health and Well-being Hub patients and the wider Shropshire CCG population.

```{r}
dmo01_union_cavell %>% 
  ggplot(aes(x = date, 
             y = cavell_activity,
             colour = diagnostic_tests
             )
         ) +
  geom_smooth(aes(), method = "loess", span = 0.3) +
  facet_wrap(~provider_org_name_short, scales = "free_y") +
  geom_label_repel(data = dmo01_union_cavell %>% 
                     filter(!is.na(label)),
                   aes(label = str_wrap(label,20)), size = 3, na.rm = TRUE, max.overlaps = 10) +
  scale_y_continuous(labels = scales::comma, limits = c(0, NA_real_), oob = squish) +
  xlim(as.Date("2016-01-20"),as.Date("2021-06-20")) +
  theme(strip.text = element_text(face = "bold"),
        legend.position = "none") +
  scale_color_SU() +
  labs(title = "Diagnostic activity in Shrewsbury Health and Well-being Hub patients by test and provider organisation",
       subtitle = "Shrewsbury Health and Well-being Hub activity derived as 12.8% of Shropshire CCG activity",
       x = "Date", 
       y = "Activity (count per month)",
       colour = "")

```

```{r}
create_dt(
  # Annual activity fields - table 
dmo01_union_cavell %>% 
  filter(diagnostic_tests != "Total") %>% 
  group_by(date, provider_org_name, diagnostic_tests) %>% 
  summarise(activity = round(sum(cavell_activity),0)) %>% 
  ungroup() %>% 
  group_by(substr(date, 1, 4), diagnostic_tests) %>% 
  summarise(annual_activity = sum(activity)) %>% 
  rename(year = 1) %>% 
  pivot_wider(id_cols = diagnostic_tests, 
              names_from = year, 
              values_from = annual_activity) %>% 
  clean_names() %>% 
  arrange(desc(x2020))
)
```

**Diagnostic activity inclusion**

Currently assuming that the imaging capabilities for the centre will include CT and MRI, while awaiting confirmation. As such, all diagnostic activity is included but can be excluded based on the following functions: 

- CT
- MRI
- X-ray
- USS
- ECG
- Echocardiography
- Flexi-sigmoidoscopy
- Other


# Mental health 

## MHSDS care contacts 

**Mental health care contact pathways for Shrewsbury Health and Well-being Hub patients, 2019.** 

Contacts classified by the following variables:

$~~~~~~~$ **All** $~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~$ **Age** $~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~$ **Contact medium** $~~~~~~~~~~~~~$ **Contact description**

```{r MHSDS contact sankey}
sankeyNetwork(Links = mhsds_contact_links, 
              Nodes = mhsds_contacts_nodes,
              Source = "source",
              Target = "target",
              Value = "care_contacts",
              NodeID = "to_value", #Merged field with node name and contact count
              nodeWidth = 15,
              unit = "care contacts", 
              fontSize = 12,
              fontFamily = "sans-serif", 
              #colourScale = mycolourscale
              )
```

'Community' includes mental health contacts in the following settings:

 - Dental
 - Care Home
 - Education
 - Nursey facility
 - Prison setting
 - Immigration facilities
 

**Mental health contacts not suitable for collocation include:** 

- Inpatient episodes
- Referrals to the Forensic Mental Health Service and the Prison Psychiatric Inreach Service


## IAPT care contacts

```{r}
# Monthly IAPT 
iapt %>% 
  select(appointment, appointment_id) %>% 
  group_by(substr(appointment,1,7)) %>%
  summarise(appt_count = n_distinct(appointment_id)) %>% 
  rename(date = 1) %>% 
  mutate(date = as.Date(paste0(date,"-01"))) %>% 
  
  ggplot(aes(x = date, y = appt_count)) +
  geom_smooth(method = 'loess', span = 0.2, colour = "#f9bf07") +
  labs(x = "Date", y = "Appointment count", 
       title = "Monthly IAPT appointments for Shrewsbury Health and Well-being Hub GP patients, 2016-20.")
```

Monthly IAPT appointments in Shrewsbury Health and Well-being Hub GP were increasing sharply during 2019 but were heavily affected by the COVID-19 pandemic. Rates returned to pre-pandemic levels by the end of 2020.

**All IAPT therapy types and patient groups considered suitable for collocation**


# Midwifery and antenatal care 

```{r}
# Monthly count
birth_episodes %>%
  filter(admission_date < "2021-01-01") %>% 
  group_by(substr(episode_start_date,1,7))%>%
  summarise(birth_episodes = n_distinct(apce_ident)) %>% 
  rename(month = 1) %>%
  mutate(month = paste0(month,"-01")) %>% 
  mutate(month = as.Date(month)) %>% 
  
  ggplot(aes(x = month, y = birth_episodes)) +
  #geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", span = 0.2, colour = "#f9bf07") + 
  labs(x = "Month", y = "Birth episodes",
       title = "Monthly births in Shrewsbury Health and Well-being Hub patients, 2016-19")
```

Using NHS guidance for standard antenatal care we can deduce that the average pregnancy will include approximately 8 primary care appointments with either a GP or a midwife, as well as 3 antenatal scans. As such we can conclude the following annual antenatal activity taking place in primary care:

```{r}
create_dt(
# Annual counts
birth_episodes %>% 
  filter(admission_date < "2021-01-01") %>% 
  group_by(substr(episode_start_date,1,4)) %>%
  summarise(birth_episodes = n_distinct(apce_ident)) %>% 
  rename(year = 1) %>% 
  mutate(antenatal_apps = birth_episodes * 8, # Approx. 8 antenatal appointments per pregnancy 
         antenatel_scans = birth_episodes * 3 # Approx 3 antenatal scans per pregnancy
         )
  )
```


**All considered suitable for collocation.**


# Combined activity baseline 

```{r}
# Monthly
phase_2_input %>% 
  pivot_longer(cols = -month) %>%
  mutate(activity_group = 
           case_when(
             str_detect(name, "GP") ~ "Primary care", 
             str_detect(name, "diag") ~ "Diagnostics",
             str_detect(name, "antenat") ~ "Antenatal",
             str_detect(name, "opa") ~ "OPA",
             str_detect(name, "shropcom_contacts") ~ "Community care",
             str_detect(name, "shropcom_domiciliary") ~ "Community care - Domiciliary",
             str_detect(name, "mh") ~ "Mental health",
             str_detect(name, "iapt") ~ "IAPT",
             str_detect(name, "ASC") ~ "ASC - place holder (5%)"
             )) %>% 
  mutate(activity_group = factor(activity_group, levels = c(
   "IAPT",
   "Antenatal",
   "Diagnostics",
   "Community care",
   "Mental health",
   "ASC - place holder (5%)",
   "Community care - Domiciliary",
   "OPA",
   "Primary care"))) %>% 
  group_by(month, activity_group) %>% 
  summarise(contacts = sum(value, na.rm = TRUE)) %>% 
  
  ggplot(aes(x = month, y = contacts, fill = activity_group)) +
  geom_col(position = "stack", width = 22) +
  scale_fill_brewer(palette = "Paired") +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Month",
       y = "Monthly Contacts",
       fill = "Contact activity",
       title = "Monthly patient activity by contact type, 2016-2021",
       subtitle = "Shrewsbury Health and Wellbeing Hub patients", 
       caption = "Note: Primary care consultation data not available before 2018")
```


**Phase 1 - Tabular output:**

```{r}
create_dt(
  phase_2_input
)
```



# Phase 2 direction

As detailed in the analysis proposal, and supplemented by client discussions, the phase 2 clinical modelling will aim to answer the following questions:

- How are the clinical needs expected to change over the next 5 years?
- What is the expected change in service demand for the combined GP population?
- How will the above demands change with varying levels of co-location of practices and wider clinical pathways?

The results of our clinical modelling will inform our calculations regarding required physical space and balance of room usage(clincal, administrative and other).

**Overview of Phase 2 demand model** 

![](Phase_2_model_diagram.png)

Our model will take the current GP population of the 8 Shrewsbury Health and Well-being Hub practices and apply various assumed changes to present the modelled demand estimate for the Shrewsbury Health and Well-being Hub; this is be mostly impacted by our co-location estimates but will also consider population demographic changes, expected service reconfigurations and increasing use of virtual/remote care. 

To apply our assumptions, we need to identify activity attributed to specific patient groups and predict how this activity will change. We plan to present time-series data to illustrate historical changes in such activity and collaboratively generate a percentage change estimate for each strand of activity.

```{r}
phase_2_dummy <-
  tribble(
    ~activity, ~start, ~end, ~direction,
    "Baseline", 0, 300000, "Baseline",
    "Co-location", 300000, 500000, "Increase",
    "Demographic", 500000, 490000, "Decrease",
    "Non-demographic", 490000, 485000, "Decrease",
    "Service configs", 485000, 510000, "Increase",
    "Virtual care", 510000, 450000, "Decrease",
    "Final", 0, 450000, "Modelled",
  ) %>% 
  mutate(id = row_number()) %>% 
  mutate(activity = fct_reorder(activity, id))

phase_2_dummy %>% 
  ggplot() +
  geom_rect(aes(x = activity, 
                xmin = id-0.5, xmax = id+0.5,
                ymin = end, ymax = start,
                fill = direction)) +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Model input", 
       y = "Activity (annual contacts)",
       fill = "",
       title = "Phase 2 dummy data - example waterfall chart output",
       subtitle = "Modelled changes to baseline Shrewsbury Health and Well-being Hub patient population activity")
```
